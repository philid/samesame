(function(){define("deep/utils",["require"],function(e){return function(e){function i(e,t,n){return expString=e.split(/\s+/,t),expString.length==1?(n=n||10,expString[0].length>n?e.substring(0,n):expString[0]):(theNewString=expString.join(" "),theNewString.length<e.length&&theNewString[theNewString.length-1]!="."&&(theNewString+="..."),theNewString)}function f(e){var t=f.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),r={},i=14;while(i--)r[t.key[i]]=n[i]||"";return r[t.q.name]={},r[t.key[12]].replace(t.q.parser,function(e,n,i){n&&(r[t.q.name][n]=i)}),r}var t=e.collider,n=e.compose,r={};r.rethrow=function(e){throw e},r.arrayInsert=function(e,t){return e.splice.apply(e,[t,0].concat(Array.prototype.slice.call(arguments,1))),e},r.interpret=function(e,t){var n=e.indexOf("{");if(n==-1)return e;var i=e.substring(0,n);n++;var s=e.length;while(n<s){var o="";while(n<s&&e[n]!="}")e[n]!=" "&&(o+=e[n]),n++;e[n]=="}"&&(i+=r.retrieveValueByPath(t,o,"."),n++);while(n<s&&e[n]!="{")i+=e[n++];e[n]=="{"&&n++}return i},r.stripFirstSlash=function(e){return e.substring(0,1)=="/"?e.substring(1):e},r.catchParenthesis=function(e){if(e[0]!="(")return null;var t=1,n=1,r="";while((e[t]!=")"||n>1)&&t<e.length)e[t]=="("&&n++,e[t]==")"&&n--,e[t]==")"?n>1&&(r+=e[t++]):r+=e[t++];return t++,{value:r,rest:e.substring(t)}},r.trimWords=function(e,t,n){return i(e.replace(/<[^>]*>/gi,""),t,n)},r.copyArray=function(e){return!e||e.length===0?[]:e.concat([])},r.cloneFunction=function(e){var t=function(){return e.apply(this,arguments)};t.prototype=e.prototype;for(property in e)e.hasOwnProperty(property)&&(t[property]=r.copy(e[property]));return t},r.copy=function l(e){if(!e)return e;var t=null;if(e.forEach){if(e._deep_shared_)return e;t=[];var r=e.length;for(var i=0;i<r;++i){var s=e[i];typeof s=="object"?t.push(l(s)):t.push(s)}}else if(typeof e=="object"){if(e instanceof RegExp)return e;if(e instanceof Date)return e;if(e._deep_shared_)return e;t={};for(var i in e){if(i=="_deep_entry")continue;var o=e[i];e.hasOwnProperty(i)&&(typeof o=="object"?t[i]=l(o):t[i]=o)}}else typeof e=="function"?e.decorator instanceof n.Decorator?t=n.cloneStart(e):t=e:t=e;return t},r.simpleCopy=function(t){if(t instanceof Array)return t.concat([]);if(t&&typeof t=="object"){if(t instanceof RegExp)return t;if(t instanceof Date)return new Date(t.valueOf());var n={};for(var r in t){if(r=="_deep_entry")continue;t.hasOwnProperty(r)&&(n[r]=t[r])}return n}return t},r.getObjectClass=function(t){if(t&&t.constructor&&t.constructor.toString){var n=t.constructor.toString().match(/function\s*(\w+)/);if(n&&n.length==2)return n[1]}return undefined},r.setValueByPath=function(t,n,r,i){if(n[0]=="/"||n.substring(0,1)=="./")i="/";var s=n.split(i||".");i=="/"&&(s[0]==""||s[0]==".")&&s.shift();var o=t;while(s.length>1){var u=s.shift();o[u]||(o[u]={}),o=o[u]}return o[s.shift()]=r},r.retrieveValueByPath=function(t,n,r){if(n[0]=="/"||n.substring(0,1)=="./")r="/";var i=n.split(r||".");r=="/"&&(i[0]==""||i[0]==".")&&i.shift();var s=t;while(i.length>1){var o=i.shift();if(!s[o])return undefined;s=s[o]}return s?s[i.shift()]:undefined},r.deletePropertyByPath=function(t,n,r){if(n[0]=="/"||n.substring(0,1)=="./")r="/";var i=n.split(r||".");r=="/"&&(i[0]==""||i[0]==".")&&i.shift();var s=t;while(i.length>1){var o=i.shift();if(!s[o])return;s=s[o]}delete s[i.shift()]},r.retrieveSchemaByPath=function(t,n,r){if(n[0]=="/"||n.substring(0,1)=="./")r="/";var i=n.split(r||".");r=="/"&&(i[0]==""||i[0]==".")&&i.shift();var s=t;while(i.length>1){var o=i.shift();if(!s.properties||!s.properties[o])return undefined;s=s.properties[o]}return s.properties?s.properties[i.shift()]:undefined},r.arrayUnique=function(t,n){if(!t.forEach)return t;var i={},s=0,o=[];return t.forEach(function(e){var t=null;n?t=r.retrieveValueByPath(e,n):e.uri&&(t=e.uri);if(t==null||t==undefined)t=String(e);typeof i[t]=="undefined"&&(i[t]=!0,o.push(e))}),o},r.arrayFusion=function(t,n,i){var s={},o=0,u=[];return t&&t.length>0&&(u=u.concat(t)),u.forEach(function(e){var t=null;i?t=r.retrieveValueByPath(e,i):e.uri&&(t=e.uri);if(t==null||t==undefined)t=String(e);s[t]=!0}),n.forEach(function(e){var t=null;i?t=r.retrieveValueByPath(e,i):e.uri&&(t=e.uri);if(t==null||t==undefined)t=String(e);typeof s[t]=="undefined"&&u.push(e)}),u},r.inArray=function(t,n){if(!n||!n instanceof Array)return!1;var r={};n.forEach(function(e){r[e]=!0});if(t.forEach){var i=0;return t.forEach(function(e){typeof r[e]!="undefined"&&i++}),i==t.length?!0:!1}return r[t]?!0:!1},r.getJSPrimitiveType=function(t){return t instanceof Array?"array":typeof t},r.deepEqual=function(t,n,i){i==undefined&&(i=!0);if(typeof t!=typeof n)return!1;if(typeof t=="object"){if(t==null&&t!==n)return!1;if(n==null&&t!==n)return!1;var s=!0,o=[],u=[];for(var a in n){if(a=="_deep_entry")continue;if(!n.hasOwnProperty(a))continue;if(typeof t[a]=="undefined")return!1;s=s&&r.deepEqual(t[a],n[a]);if(!s)return!1;u.push(a)}for(var a in t){if(a=="_deep_entry")continue;if(!t.hasOwnProperty(a))continue;o.push(a)}if(o.length!=u.length)return!1;if(i)for(var f=0;f<u.length;++f)if(u[f]!=o[f])return!1}else if(t!==n)return!1;return!0};var s=r.retrieveFullSchemaByPath=function(t,n,i){n+="";if(n[0]=="/"||n.substring(0,1)=="./")i="/";var s=n.split(i||".");i=="/"&&(s[0]==""||s[0]==".")&&s.shift();var o=t;while(s.length>1){var u=s.shift();if(u.match(/^[0-9]*$/)&&o.type=="array"){o=o.items||{};continue}if(!o.properties||!o.properties[u])return undefined;o=o.properties[u]}var a=s.shift(),f=[];if(a.match(/^[0-9]*$/))o.type=="array"&&(o=o.items||{},f.push(o));else{o.properties&&o.properties[a]&&f.push(o.properties[a]);if(o.patternProperties)for(var l in o.patternProperties)(new RegExp(l)).test(a)&&f.push(o.patternProperties[l]);if(f.length==0)return o.additionalProperties==undefined||o.additionalProperties==0?undefined:o.additionalProperties}var c={};return f.length>1?f.forEach(function(e){c=r.up(e,c)}):f.length==1&&(c=f[0]),c};r.deepArrayFusion=function(t,n,i,s){var o={},u=0,a=[],f={},l=null;return i&&(i.items&&(f=i.items),i.collision&&i.collision.unique&&(l=i.collision.unique===!0?null:i.collision.unique)),t&&t.length>0&&(a=a.concat(t)),a.forEach(function(e){var t=null;l?t=r.retrieveValueByPath(e,l):e.uri?t=e.uri:e.id&&(t=e.id);if(t==null||t==undefined)t=String(e);o[t]={ref:e,index:u++}}),n.forEach(function(e){var t=null;l?t=r.retrieveValueByPath(e,l):e.uri?t=e.uri:e.id&&(t=e.id);if(t==null||t==undefined)t=String(e);o[t]?s?a[o[t].index]=r.bottom(e,o[t].ref,f):a[o[t].index]=r.up(e,o[t].ref,f):a.push(e)}),a};var o=function(i,o,u,a,f){if(typeof i=="undefined")return o;if(i===null)return a&&f&&(a[f]=null),null;var l=null,c=r.getJSPrimitiveType(i),h=r.getJSPrimitiveType(o);if(c==="function")if(h==="function")if(i.decorator&&i.decorator instanceof n.Decorator){if(i.decorator.condition&&typeof i.decorator.condition=="function"&&!i.decorator.condition())return o;l=n.up(o,i)}else i._deep_collider?o._deep_collider?l=t.wrap(i,o):l=i(o,a,f):l=i;else if(i.decorator&&i.decorator instanceof n.Decorator){if(typeof o!="undefined")throw new Error("deep.compose need to be applied on function ! ");if(i.decorator.ifExists)return o;l=i}else i._deep_collider?l=i(o,a,f):l=i;if(l)return a&&f&&(a[f]=l),l;if(typeof o=="undefined"||o===null)return o=r.copy(i),a&&f&&(a[f]=o),o;if(c!==h)return o=r.copy(i),a&&f&&(a[f]=o),o;switch(c){case"array":return l=r.deepArrayFusion(o,i,u),a&&f&&(a[f]=l),l;case"object":if(i instanceof RegExp)return a&&f&&(a[f]=i),i;if(i instanceof Date)return o=new Date(i.valueOf()),a&&f&&(a[f]=o),o;for(var p in i){if(p=="_deep_entry")continue;if(i[p]==null){o[p]=null;continue}if(i[p]&&i[p]._deep_colliderRemove){delete o[p];continue}var d={};u&&(d=s(u,p)),typeof i[p]=="object"||typeof i[p]=="function"?o[p]=r.up(i[p],o[p],d,o,p):o[p]=i[p]}return o;default:return a&&f&&(a[f]=i),i}},u=function(i,o,u,a,f){if(i===null||typeof i=="undefined")return o;if(o==null)return o;if(typeof o=="undefined")return o=r.copy(i),a&&f&&(a[f]=o),o;var l=null,c=r.getJSPrimitiveType(i),h=r.getJSPrimitiveType(o);if(h==="function")if(c==="function")o.decorator&&o.decorator instanceof n.Decorator?l=n.bottom(i,o):o._deep_collider?i._deep_collider?l=t.wrap(o,i):l=o(i,a,f):l=o;else{if(o.decorator&&o.decorator instanceof n.Decorator)throw new Error("deep.compose need to be applied on function ! ");o._deep_collider?l=o(i,a,f):l=o}if(l)return a&&f&&(a[f]=l),l;if(c!==h)return o;switch(c){case"array":return l=r.deepArrayFusion(i,o,u,!0),a&&f&&(a[f]=l),l;case"object":var p={};for(var d in o){if(d=="_deep_entry")continue;p[d]=o[d],delete o[d]}for(var d in i){if(d=="_deep_entry")continue;o[d]=r.copy(i[d])}for(var d in p){var v=p[d],m=o[d];if(d=="_deep_entry")continue;if(v==null){o[d]=null;continue}if(v&&v._deep_colliderRemove){delete o[d];continue}var g={};u&&(g=s(u,d)),typeof v=="object"||typeof v=="function"?o[d]=r.up(v,m,g,o,d):o[d]=v}return o;default:return o}},a=r.deepCopy=function(t,n,i,s,o,u){return i=i!=null&&i!=undefined?i:!0,i?r.up(t,n,s,o,u):r.bottom(t,n,s,o,u)};return r.up=o,r.bottom=u,r.createRangeObject=function(e,t,n){var r={total:n,start:0,end:0,hasNext:!1,hasPrevious:!1,next:function(e){return this.hasNext?(this.start+=e,this.end=this.start+(e-1),this.update(this.start,this.end)):this},previous:function(e){return this.hasPrevious?(this.start-=e,this.end=this.start+(e-1),this.update(this.start,this.end)):this},update:function(e,t,n){return this.total=n||this.total||0,this.total==0?(this.start=this.end=0,this):(this.start=Math.max(Math.min(this.total-1,e),0),this.end=Math.max(Math.min(t,this.total-1),0),this.hasNext=this.end<this.total-1,this.hasPrevious=this.start>0,this)}};return r.update(e,t,n),r},r.parseJson=function(e){var t="";e.forEach?e.forEach(function(e){t+=e.toString()}):t=e.toString();var n=JSON.parse(t);return typeof n=="string"?JSON.parse(n):n},r.parseBody=function(e,t){if(typeof e=="undefined"||e==null)return null;var n=e;n instanceof Array&&(n="",e.forEach(function(e){n+=e.toString()})),e=n;var i=t["content-type"]||t["Content-Type"]||"application/json";i=i.split(";")[0];try{switch(i){case"application/json-rpc":return r.parseJson(e);case"application/json":return r.parseJson(e);case"application/javascript":return r.parseJson(e);default:return e}}catch(s){return new Error("error while parsing body : "+JSON.stringify(s))}},f.options={strictMode:!0,key:["href","protocol","host","userInfo","user","password","hostname","port","relative","pathname","directory","file","search","hash"],q:{name:"query",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},r.parseURL=function(e){var t=f(e);return t.search&&(t.search="?"+t.search),t.path=t.pathname+t.search,t},r.dumpError=function(e){typeof e=="object"&&e!==null?(console.log("\n\n**************************** (deep) Error Dump : \n"),e.status&&console.log("\nStatus: "+e.status),e.message&&console.log("\nMessage: "+e.message),e.stack&&(console.log("\nStacktrace:"),console.log("===================="),console.log(e.stack)),e.report&&(console.log("\nReport:"),console.log("===================="),console.log(e.report),console.log("============================================================"))):console.warn("dumpError :: argument is not an object : ",e)},r.logItemsProperty=function(e,t){var n=[];return e.forEach(function(e){console.log("deep.logItemsProperty : ",t,e[t]),n.push(e[t])}),n},r.execTreatment=function(t){if(!this.how||this.condition===!1)return!1;if(typeof this.condition=="function"&&!this.condition.apply(this))return!1;t=t||this;var n=this,r=[];if(typeof this.what=="string"){var i=e.interpret(this.what,t);r.push(e.get(i,{root:t._deep_entry||t}))}else typeof this.what=="function"?r.push(this.what.apply(controller)):this.what&&r.push(this.what);if(typeof this.how=="string"){var s=e.interpret(this.how,t);r.push(e.get(s,{root:t._deep_entry||t}))}if(typeof this.where=="string"){var o=e.interpret(this.where,t);r.push(e.get(o,{root:t._deep_entry||t,acceptQueryThis:!0}))}return e.all(r).done(function(e){var r=n.what?e.shift():t;r._isDQ_NODE_&&(r=r.value);var i=typeof n.how=="string"?e.shift():n.how,s=typeof n.where=="string"?e.shift():n.where,o="",u=n.nodes||null;try{o=i.apply({},[r]),s&&(u=s(o,u))}catch(a){return console.log("Error while treating : ",a),typeof n.fail=="function"?n.fail.apply(t,[a])||a:a}return typeof n.done=="function"?n.done.apply(t,[u,o,r])||[u,o,r]:u||o}).fail(function(e){return console.log("Error while treating : ",e),typeof n.fail=="function"?n.fail.apply(t,[e])||e:e})},r.loadTreatments=function(t,n,r){typeof r=="undefined"&&(r=!1);var i=[];for(var s in t){var o=null;r?o=t[s]:(o=e.utils.copy(t[s]),o.source=t[s]);if(!o.how||o.condition===!1)continue;if(o.condition&&typeof o.condition=="function"&&!o.condition.apply(n))continue;i.push(o);var u=[];o.what&&(typeof o.what=="string"?(o.what=e.interpret(o.what,n),o.what=e.get(o.what,{root:n._deep_entry||n})):typeof o.what=="function"&&(o.what=o.what.apply(n))),typeof o.how=="string"&&(o.how=e.interpret(o.how,n),o.how=e.get(o.how,{root:n._deep_entry||n})),typeof o.where=="string"&&(o.where=e.interpret(o.where,n),o.where=e.get(o.where,{root:n._deep_entry||n})),u.push(o.what,o.how,o.where)}return e.all(u).done(function(e){var t=i.length,n=0;for(var r=0;r<t;r++){var s=i[r];s.what=e[n++],s.how=e[n++],s.where=e[n++]}return i}).fail(function(e){return typeof o.fail=="function"?o.fail.apply(n,[e])||e:[{},function(){return""},function(){}]})},r.applyTreatments=function(e,t,n){var r=[],i=e.length;return e.forEach(function(e){if(!e.how||e.condition===!1)return;if(e.condition&&typeof e.condition=="function"&&!e.condition.apply(t))return;var i=e.what||t,s=e.how,o=e.where,u="",a=null;i._isDQ_NODE_&&(i=i.value),n&&e.sended&&(a=e.sended()||null);try{u=s.call(t,i),o?a=o.call(t,u,a):a=null}catch(f){return typeof e.fail=="function"?r.push(e.fail.apply(t,[f])||f):r.push(f)}return n&&(e.source?e.source.sended=function(){return a}:e.sended=function(){return a}),typeof e.done=="function"?r.push(e.done.apply(t,[a,u,i])||[a,u,i]):r.push([a,u,i])}),r},r.sheet=function(n,r,i){i=i||{},i.entry=r;var s=[];for(var o in n){var u=n[o];e.when(e.get(o,i)).pushHandlerTo(s).done(function(e){return e(u,i)})}return e.all(s)},r.decorateUpFrom=function(e,t,n){n.forEach(function(n){typeof e[n]!="undefined"&&r.up(e[n],t[n],null,t,n)})},r.series=function(t,n){function s(r){return e.when(r.call(n)).done(function(e){return i.push(e),t.length>0?s(t.shift()):i})}var r=n,i=[];return s(t.shift())},r}}),define("rql/parser",["exports"],function(e){function n(n,i){function f(t){s.args.push(t),s=t,e.lastSeen.indexOf(s.name)>=0&&(o.cache[s.name]=s.args)}function l(e){if(!s.name)s.name=e;else if(s.name!==e)throw new Error("Can not mix conjunctions within a group, use paranthesis around each set of same conjuctions (& and |)")}function c(e){return e&&e.args&&(delete e.parent,e.args.forEach(c)),e}if(typeof n=="undefined"||n===null)n="";var s=new e.Query,o=s;o.cache={};if(typeof n=="object"){if(n instanceof e.Query)return n;for(var u in n){var s=new e.Query;o.args.push(s),s.name="eq",s.args=[u,n[u]]}return o}if(n.charAt(0)=="?")throw new URIError("Query must not start with ?");e.jsonQueryCompatible&&(n=n.replace(/%3C=/g,"=le=").replace(/%3E=/g,"=ge=").replace(/%3C/g,"=lt=").replace(/%3E/g,"=gt=")),n.indexOf("/")>-1&&(n=n.replace(/[\+\*\$\-:\w%\._]*\/[\+\*\$\-:\w%\._\/]*/g,function(e){return"("+e.replace(/\//g,",")+")"})),n=n.replace(/(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)([<>!]?=(?:[\w]*=)?|>|<)(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)/g,function(e,n,r,i){if(r.length<3){if(!t[r])throw new URIError("Illegal operator "+r);r=t[r]}else r=r.substring(1,r.length-1);return r+"("+n+","+i+")"}),n.charAt(0)=="?"&&(n=n.substring(1));var a=n.replace(/(\))|([&\|,])?([\+\*\$\-:\w%\._]*)(\(?)/g,function(t,n,u,a,c){u&&(u==="&"&&l("and"),u==="|"&&l("or"));if(c){var h=new e.Query;h.name=a,h.parent=s,f(h)}else if(n){var p=!s.name;s=s.parent;if(!s)throw new URIError("Closing paranthesis without an opening paranthesis");p&&s.args.push(s.args.pop().args)}else if(a||u===","){s.args.push(r(a,i)),e.lastSeen.indexOf(s.name)>=0&&(o.cache[s.name]=s.args);if(s.name==="eq"&&s.args[0]===e.primaryKeyName){var d=s.args[1];d&&!(d instanceof RegExp)&&(d=d.toString()),o.cache[e.primaryKeyName]=d}}return""});if(s.parent)throw new URIError("Opening paranthesis without a closing paranthesis");if(a)throw new URIError("Illegal character in query string encountered "+a);return c(o),o}function r(t,n){var r=e.converters["default"];if(t.charAt(0)==="$"){var i=parseInt(t.substring(1))-1;return i>=0&&n?n[i]:undefined}if(t.indexOf(":")>-1){var s=t.split(":",2);r=e.converters[s[0]];if(!r)throw new URIError("Unknown converter "+s[0]);t=s[1]}return r(t)}var t={"=":"eq","==":"eq",">":"gt",">=":"ge","<":"lt","<=":"le","!=":"ne"};e.primaryKeyName="id",e.lastSeen=["sort","select","values","limit"],e.jsonQueryCompatible=!0,e.parse=e.parseQuery=n,e.parseGently=function(){var t;try{t=n.apply(this,arguments)}catch(r){t=new e.Query,t.error=r.message}return t},e.commonOperatorMap={and:"&",or:"|",eq:"=",ne:"!=",le:"<=",ge:">=",lt:"<",gt:">"};var i=e.autoConverted={"true":!0,"false":!1,"null":null,"undefined":undefined,Infinity:Infinity,"-Infinity":-Infinity};return e.converters={auto:function(t){if(i.hasOwnProperty(t))return i[t];var n=+t;if(isNaN(n)||n.toString()!==t)return t=decodeURIComponent(t),e.jsonQueryCompatible&&t.charAt(0)=="'"&&t.charAt(t.length-1)=="'"?JSON.parse('"'+t.substring(1,t.length-1)+'"'):t;return n},number:function(e){var t=+e;if(isNaN(t))throw new URIError("Invalid number "+t);return t},epoch:function(e){var t=new Date(+e);if(isNaN(t.getTime()))throw new URIError("Invalid date "+e);return t},isodate:function(t){var n="0000".substr(0,4-t.length)+t;return n+="0000-01-01T00:00:00Z".substring(n.length),e.converters.date(n)},date:function(e){var t=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(e);t?date=new Date(Date.UTC(+t[1],+t[2]-1,+t[3],+t[4],+t[5],+t[6])):date=new Date(e);if(isNaN(date.getTime()))throw new URIError("Invalid date "+e);return date},"boolean":function(e){return e==="true"},string:function(e){return decodeURIComponent(e)},re:function(e){return new RegExp(decodeURIComponent(e),"i")},RE:function(e){return new RegExp(decodeURIComponent(e))},glob:function(e){var t=decodeURIComponent(e).replace(/([\\|\||\(|\)|\[|\{|\^|\$|\*|\+|\?|\.|\<|\>])/g,function(e){return"\\"+e}).replace(/\\\*/g,".*").replace(/\\\?/g,".?");return t.substring(0,2)!==".*"?t="^"+t:t=t.substring(2),t.substring(t.length-2)!==".*"?t+="$":t=t.substring(0,t.length-2),new RegExp(t,"i")}},e.converters["default"]=e.converters.auto,e.Query=function(){this.name="and",this.args=[]},e}),define("deep/deep-rql",["require","rql/parser"],function(e){return function(t){function u(e){return e&&(e instanceof Array||e.push)?"array":typeof e}function v(e,t){var n=function(n,r){typeof r=="undefined"&&(r=n,n=undefined);var i=arguments,s=[];for(var o=0,u=this.length;o<u;o++){var a=this[o];e(g(a,n),r)&&s.push(a)}return s};return n.condition=e,n}function m(e){return function(t){return t?this.map(function(e){return d(e,t)}).reduce(e):this.reduce(e)}}function g(e,t){return t instanceof Array?d(e,decodeURIComponent(t)):typeof t=="undefined"?d(e):d(e,decodeURIComponent(t))}function S(e,t,r){function l(){}function m(e){if(e&&typeof e=="object"){if(e instanceof Array)return"["+e.map(m)+"]";var t=n.jsOperatorMap[e.name];if(t){var r=e.args[0],i=e.args[1],s="";typeof i=="undefined"?(s="item",i=r,w&&(s+="."+w)):s="val&&val";var u=s+t+m(i);if(typeof Array.prototype.filter=="function")return"(function applyNativeArrayFilter(){return this.filter(function(item){var val = RQL_Global.retrieve(item,'"+r+"'); return "+u+"})})";throw"error : array have no filter"}return"(function(){var opo = RQL_Global.op('"+e.name+"');"+"return opo"+".call(this"+(e&&e.args&&e.args.length>0?", "+e.args.map(m).join(","):"")+")"+"})"}return typeof e=="string"?o(e):e}var i=t;r=r||{};var u=E[i];if(u)return e?u(e):u;try{var a=s(i,r.parameters)}catch(f){return console.log("deep-rql : parse error : ",i),f}prefix=r.prefix||null,w=prefix||null,b=r.schema||null,y=r.cache||null,l.prototype=n.operators;var c=new l,h=function(t){return c[t]||n.missingOperator(t)};RQL_Global.op=h;for(var p in r.operators)c[p]=r.operators[p];var d=r.parameters||[],v="",g="return "+m(a)+".call(target);",S=new Function("target",g);E[i]=S;try{return e?S(e):S}catch(f){throw console.log("WARNING : RQL throw : ",JSON.stringify(f)),f}}RQL_Global={};var n={},r=t.retrieveFullSchemaByPath,i=e("rql/parser"),s=i.parseQuery,o=JSON.stringify||function(e){return'"'+e.replace(/"/g,'\\"')+'"'};n.jsOperatorMap={eq:"===",ne:"!==",le:"<=",ge:">=",lt:"<",gt:">"};var a=RQL_Global.isPresent=function(t,n){var r=[];return n.forEach(function(e){d(e,t)&&r.push(e)}),r},f=RQL_Global.rewritePath=function(t){var n=t||[];return typeof n=="string"&&(n=n.split(".")),w&&n[0]!="_schema"&&n[0]!="_parent"&&n.unshift(w),n},l=RQL_Global.retrieveSchemaProp=function(n,r,i,s){i[0]=="_schema"&&i.shift();var o=r;if(!r){if(i.length==1&&i[0]=="type")return i.shift(),u(s);if(i.length==1&&i[0]=="depth")return i.shift(),n.split("/").length;if(i.length==1&&i[0]=="class")return i.shift(),t.getObjectClass(s)}if(i.length==0||!o)return o||{};var a=t.retrieveValueByPath(o,i.join("."));return!a&&i.length==1&&i[0]=="type"?(i.shift(),u(s)):a},c=RQL_Global.retrieveParent=function(t,n,r){var i=t;while(i.ancestor&&r>0)i=i.ancestor,r--;return r!=0&&(i=null),i},h={},p=RQL_Global.getRetrieveFunc=function(t){if(h[t])return h[t];var n="",r=f(t);if(r.length==0)return h[t]=new Function("object","return object;");if(r[0]=="_parent"){var i=0;while(r.length>0&&r[0]=="_parent")i++,r.shift();n+="object = RQL_Global.retrieveParent(object, null, "+i+"); if(object == null) return null; ";if(r.length==0)return n+="return object;",h[t]=new Function("object",n);w&&r[0]!="_schema"&&r.unshift(w)}if(r[0]=="_schema"){r.shift(),n+="var res = RQL_Global.retrieveSchemaProp(object.path, object.schema, ['"+r.join("']['")+"'], "+(w?"object['"+w+"']":"object")+"); return res;";var s=new Function("object",n);return h[t]=s,s}n+="var fullPath = object.path;";var o=r[0],u=[],a="object",l=!1,c="";for(var p=0;r.length>0;p++){o=r.shift(),u.push(o),c=u.join("']['");if(o=="_schema"){n+="if("+a+") object = object['"+c+"']; else return null;",n+="return RQL_Global.retrieveSchemaProp(fullPath+'."+u.join(".")+"', object.schema, ['"+r.join("']['")+"'], object);",l=!0;break}a+="&&object['"+c+"']"}l||(n+="if("+a+") return object['"+c+"']; else return null;");var s=new Function("object",n);return h[t]=s},d=function(t,n){var r=p(n)(t);return r};RQL_Global.retrieve=d,n.instanceOfs={Array:{}},n.operators={sort:function(){var t=[];for(var n=0;n<arguments.length;n++){var r=arguments[n],i=r.charAt(0),s={attribute:r,ascending:!0};if(i=="-"||i=="+")i=="-"&&(s.ascending=!1),s.attribute=s.attribute.substring(1);t.push(s)}return this.sort(function(e,n){for(var r,i=0;r=t[i];i++){var s=d(e,r.attribute),o=d(n,r.attribute);if(s!=o)return r.ascending==s>o?1:-1}return 0}),this},match:v(function(t,n){return(new RegExp(n)).test(t)}),instanceOf:function(t,r){var i=!1,s=0;for(var o in r){n.instanceOfs&&n.instanceOfs[o]?i=i&&n.instanceOfs[o](t):i=!1;if(!i)break}return i},"in":v(function(t,n){var r=!1,i=0;while(!r&&i<n.length)n[i++]==t&&(r=!0);return r}),out:v(function(t,n){var r=!0,i=0;while(r&&i<n.length)n[i++]==t&&(r=!1);return r}),contains:v(function(n,r){return t.inArray(r,n)}),excludes:v(function(n,r){return!t.inArray(r,n)}),or:function(){var t=[];for(var n=0;n<arguments.length;++n)typeof arguments[n]=="function"?t=t.concat(arguments[n].call(this)):t=t.concat(a(arguments[n],t));return t},and:function(){var t=this;for(var n=0;n<arguments.length;++n)typeof arguments[n]=="function"?t=arguments[n].call(t):t=a(arguments[n],t);return t},select:function(){var t=arguments,n=arguments.length,r=this.map(function(e){var r={};for(var i=0;i<n;i++){var s=t[i],o=g(e,s);console.log("rql select : ",s," - value : ",o," - object : ",e),typeof o!="undefined"&&(r[s]=o)}return r});return console.log("rql select res : ",r),r},unselect:function(){var t=arguments,n=arguments.length;return this.map(function(e){var r={};for(var i in e)e.hasOwnProperty(i)&&(r[i]=e[i]);for(var i=0;i<n;i++)delete r[t[i]];return r})},values:function(t){if(arguments.length==1)return this.map(function(e){return d(e,t)});var n=arguments,r=arguments.length;return this.map(function(e){var t=d(e),i=[];if(r===0)for(var s in t)t.hasOwnProperty(s)&&i.push(t[s]);else for(var s=0;s<r;s++){var o=n[s];i.push(t[o])}return i})},limit:function(t,n,r){var i=this.length;n=n||0;var s=this.slice(n,n+t);return r&&(s.start=n,s.end=n+s.length-1,s.totalCount=Math.min(i,typeof r=="number"?r:Infinity)),s},distinct:function(){var t={},n=[],r=this.filter(function(e){return e=d(e),e&&typeof e=="object"?e.__found__?!1:(e.__found__=function(){},n.push(e),!0):t[e]?!1:(t[e]=!0,!0)});return n.forEach(function(e){delete e.__found__}),r},recurse:function(t){function r(e){if(e instanceof Array)e.forEach(r);else{n.push(e);if(t)e=e[t],e&&typeof e=="object"&&r(e);else for(var i in e)e[i]&&typeof e[i]=="object"&&r(e[i])}}var n=[];return r(d(this)),n},aggregate:function(){var t=[],n=[];for(var r=0;r<arguments.length;r++){var i=arguments[r];typeof i=="function"?n.push(i):t.push(i)}var s={},o=t.length;this.forEach(function(e){e=d(e);var n="";for(var r=0;r<o;r++)n+="/"+e[t[r]];var i=s[n];i||(i=s[n]=[]),i.push(e)});var u=n.length,a=[];for(var f in s){var l=s[f],c={};for(var r=0;r<o;r++){var h=t[r];c[h]=l[0][h]}for(var r=0;r<u;r++){var p=n[r];c[r]=p.call(l)}a.push(c)}return a},between:v(function(t,n){return t=d(t),t>=n[0]&&t<n[1]}),sum:m(function(t,n){var t=d(t),n=d(n);return t+n}),mean:function(t){return n.operators.sum.call(this,t)/this.length},max:m(function(t,n){var t=d(t),n=d(n);return Math.max(t,n)}),min:m(function(t,n){var t=d(t),n=d(n);return Math.min(t,n)}),count:function(){return this.length},first:function(){return this[0]},last:function(){return this[this.length-1]},random:function(){return this[Math.round(Math.random()*(this.length-1))]},one:function(){if(this.length>1)throw new TypeError("More than one object found");return this[0]}},n.filter=v,n.evaluateProperty=g,n.executeQuery=function(t,r,i){return n.query(t,r,i)},n.query=S,n.missingOperator=function(t){throw new Error("Operator "+t+" is not defined")};var y=null,b=null,w=null,E={};return n}}),define("deep/deep-schema",["require"],function(e,t,n,r){return function(e){function i(e,t){var n=[];for(var r in t){if(!t.hasOwnProperty(r))continue;(new RegExp(r)).test(e)&&n.push(t[r])}return n}var t=e.utils,n=e,r=e.Querier,s=function(){},o=s.prototype.getType=function(e){for(var t in this.lexic.type)if(this.lexic.type.hasOwnProperty(t)&&t!="any"&&t!="object"&&t!="schema"&&this.lexic.type[t].test.apply(this,[e]))return t;return this.lexic.type.object.test.apply(this,[e])?"object":null};s.prototype.convertStringTo=function(e,t){switch(t){case"number":e=parseFloat(e);break;case"float":e=parseFloat(e);break;case"integer":e=parseInt(e);break;case"boolean":e=e=="true"||e=="1"?!0:!1;break;default:e}return e},s.prototype.errors=null,s.prototype.errorsMap=null,s.prototype.doTest=function(t,n,r,i,s,o,u){t.test&&!t.test.apply(this,[n,r,i,s,o,u])&&this.createError(t.error,n,r,i,s,o,u)},s.prototype.createError=function(n,r,i,s,o,u,a){a||(a="");var f=e.utils.interpret(n,{value:r,type:i,path:o,schema:s,schemaPath:u,__this:this}),l={detail:f,value:r,type:i,schema:s,path:o,schemaPath:u,schemaProperty:a};return this.errorsMap||(this.errorsMap={}),this.errorsMap[o]||(this.errorsMap[o]={}),this.errorsMap[o].errors||(this.errorsMap[o].errors=[]),this.errorsMap[o].errors.push(l),console.flags&&console.flags.validationError&&console.log("validator","create error : ",JSON.stringify(l)),this.errors.push(l),l},s.prototype.checkRef=function(t,n,r,i,s){s==undefined&&(s=this.validateProperty);var o=this;return s.apply(o,[t,n,r,i])},s.prototype.validateSchema=function(t,r){this.errorsMap={},this.errors=[];var i=this,s=n.Deferred();this.options=r|{},this.options.basePath||(this.options.basePath=""),this.options.baseSchemaPath||(this.options.baseSchemaPath=""),this.validateSchemaProperties(null,t,null,this.options.basePath);var o={errorsMap:i.errorsMap,schema:t,value:null,date:Date.now(),valid:i.errors.length==0};return o},s.prototype.validate=function(n,r,i){if(i&&i.partial)return i.fieldsToCheck=e.query(n,".//*").paths(),this.partialValidation(n,r,i);this.rootValue=n,this.errors=[],this.errorsMap={};var s=this;this.options=i||{},this.options.basePath||(this.options.basePath=""),this.options.baseSchemaPath||(this.options.baseSchemaPath=""),this.validateProperty(n,r,this.options.basePath,this.options.baseSchemaPath);var o={errorsMap:s.errorsMap,schema:r,value:n,date:Date.now(),valid:s.errors.length==0};return o},s.prototype.partialValidation=function(r,i,s){this.errors=[],this.errorsMap={},this.options=s||{};var o=s.fieldsToCheck||[],u=[],a=[],f=[],l=n.Deferred(),c=this;return o.forEach(function(e){var n=t.retrieveFullSchemaByPath(i,e);if(!n)return;var s=t.retrieveValueByPath(r,e);if(s!=""&&!s&&n.required){c.createError(c.lexic[c.lexic.__requiredEquivalent].error,s,"undefined",n,e);return}a.push(c.validate(s,n,{basePath:e,baseSchemaPath:null}))}),n.all(a).then(function(t){var n=!0;t.forEach(function(t){if(!t.valid){n=!1;for(var r in t.errorsMap)c.errorsMap[r]||(c.errorsMap[r]={errors:[]}),c.errorsMap[r].errors=t.errorsMap[r].errors}}),l.resolve({schema:i,value:r,errorsMap:c.errorsMap,valid:n,date:Date.now(),partial:!0})}),n.promise(l)},s.prototype.validateSchemaProperties=function(t,n,r,i){var s=[];for(var u in n){if(!n.hasOwnProperty(u))continue;var a=o.apply(this,[n[u]]);switch(u){case"type":(typeof n.type!="string"||!this.lexic.type[n.type])&&this.createError(this.lexic.__additionalErrors.unknownSchemaType,n.type,this.getType(n.type),null,null,i,"type");break;case"format":(typeof n.format!="string"||!this.lexic.__defaultPattern[n.format])&&this.createError(this.lexic.__additionalErrors.unknownFormatType,n.format,this.getType(n.format),null,null,i,"format");break;case"pattern":(typeof n.pattern!="string"||!this.lexic.__defaultPattern[n.pattern])&&this.createError(this.lexic.__additionalErrors.unknownFormatType,n.pattern,this.getType(n.pattern),null,null,i,"pattern");break;default:s.push(this.checkRef(n[u],this.lexic[u].schema,i,u+".schema"))}}return s},s.prototype.validateProperty=function(e,n,s,u){var a=[],f=this.getType(e);if(this.options.forceConversion&&n.type!=f)switch(n.type){case"number":e=parseFloat(e);break;case"float":e=parseFloat(e);break;case"integer":e=parseInt(e);break;case"boolean":e=e=="true"||e=="1"||e==1?!0:!1;break;default:}var l=this;f==null&&(f=typeof e),n.type||(n.type="object");var c=n.type;c.push||(c=[c]);var h=!1;for(var p=0;p<c.length;++p){if(c[p]=="schema"){f!="object"?this.createError(this.lexic.__additionalErrors.schemaIsNotObject,e,f,n,s,u,u+".type"):a.push(this.validateSchemaProperties(null,e,null,s));return}if(!this.lexic.type[c[p]]){this.createError(this.lexic.__additionalErrors.unknownSchemaType,e,f,n,s,u,u+".type");continue}if(f==c[p]||c[p]=="any"){h=!0;break}}h||this.createError(this.lexic.__additionalErrors.badType,e,f,n,s,u,u+".type");var d=!1;n.dependencies&&n.dependencies.length>0&&n.dependencies.forEach(function(t){var n=r.query(e,t.query);if(n.length>0){d=!0;var i=l.validateProperty(e,t.constraints,s,u);h=h&&i.valid}});if(!d&&n.items&&f=="array")if(n.items.push){var p=0;for(;p<n.items.length;++p)a.push(this.checkRef(e[p],n.items[p],s+"."+p,u+".items["+p+"]"));if(p<e.length&&(n.additionalItems==undefined||n.additionalItems!==!1))for(;p<e.length;++p)a.push(this.checkRef(e[p],n.additionalItems||{},s+"["+p+"]",u+".additionalItems"));else n.additionalItems===!1&&this.createError(this.lexic.additionalItems.error,e,f,n,s+"["+p+"]",u+".items")}else for(var p=0;p<e.length;++p)a.push(this.checkRef(e[p],n.items,s+"."+p,u+".items"));if(!d&&f=="object"){for(var p in e){if(!e.hasOwnProperty(p))continue;var v=[];n.patternProperties&&(v=i(p,n.patternProperties)),n.properties&&n.properties[p]&&v.push(n.properties[p]);if(v.length==0)n.additionalProperties==undefined||n.additionalProperties!==!1?a.push(this.checkRef(e[p],n.additionalProperties||{type:"any"},s+"."+p,u+".additionalProperties")):n.additionalProperties===!1&&this.createError(this.lexic.additionalProperties.error,e[p],o.apply(this,[e[p]]),n,s+"."+p,u+".properties."+p);else{var m={};v.forEach(function(n){t.deepCopy(n,m)}),a.push(this.checkRef(e[p],m,s+"."+p,u+".(merged)properties."+p))}}if(this.lexic[this.lexic.__requiredEquivalent].schema.type=="boolean")for(var p in n.properties)n.properties[p][this.lexic.__requiredEquivalent]&&typeof e[p]=="undefined"&&this.createError(this.lexic[this.lexic.__requiredEquivalent].error,e[p],"undefined",n,s+"."+p,u+".properties."+p)}if(!d)for(var p in n){if(!n.hasOwnProperty(p))continue;switch(p){case"type":break;case"properties":break;case"dependencies":break;case"patternProperties":break;case"items":break;case"additionalItems":break;case"additionalProperties":break;default:this.lexic[p]?this.doTest(this.lexic[p],e,f,n,s,u):console.flags&&console.flags.validator&&console.log("validator","unrecognised schema property : "+p)}}return a},s.prototype.applyLexic=function(n){t.up(n,this.lexic)},s.prototype.lexic={__additionalErrors:{schemaIsNotObject:"{ path }, trying to validate a schema (type:'schema') but the value isn't an object : Value provided : { value }",badType:"{ path }, type not allowed. Allowed type :  { schema.type }",unknownSchemaType:"type from schema is unknown : { schema.type }"},__requiredEquivalent:"required",__defaultPattern:{uri:{test:function(e){return/.*/g.test(e)},error:"need to be with uri format"},date:{test:function(e){return/.*/g.test(e)},error:"need to be with date format"},phone:{test:function(e){return/.*/g.test(e)},error:"need to be with phone format"},email:{test:function(e){return/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/gi.test(e)},error:"need to be with email format"},zip:{test:function(e){return/.*/g.test(e)},error:"need to be with zip format"},ipv4:{test:function(e){return/.*/g.test(e)},error:"need to be with ipv4 format"},ipv6:{test:function(e){return/.*/g.test(e)},error:"need to be with ipv6 format"},"date-time":{test:function(e){return/.*/g.test(e)},error:"need to be with date-time format"},"utc-millisec":{test:function(e){return/.*/g.test(e)},error:"need to be with date-time format"}},type:{any:{test:function(e){return!0}},object:{test:function(e){return typeof e=="object"},error:"{ path } need to be float. Value provided : { value }"},"boolean":{test:function(e){return e===!0||e===!1},error:"{ path } need to be float. Value provided : { value }"},number:{test:function(e){return typeof e=="number"&&!isNaN(e)},error:"{ path } need to be float. Value provided : { value }"},integer:{test:function(e){return typeof e=="number"&&parseInt(String(e))!=NaN},error:"{ path } need to be integer. Value provided : { value }"},"null":{test:function(e){return e===null},error:"{ path } need to be null. Value provided : { value }"},string:{test:function(e){return typeof e=="string"},error:"{ path } need to be string. Value provided : { value }"},array:{test:function(e){return e instanceof Array},error:"{ path } need to be array. Value provided : { value }"},schema:{test:function(e){return typeof e=="object"},error:"{ path } need to be true. Value provided : { value }"}},dependencies:{schema:{type:"array",items:{properties:{query:{type:"string",required:!0},constraints:{type:"schema"}}}},test:function(e,n,i,s,o){var u=this,a=!0;return i.dependencies&&i.dependencies.length>0&&i.dependencies.forEach(function(n){var f=r.query(e,n.query);if(f.length>0){var l={};for(var c in i){if(!i.hasOwnProperty(c)||c=="dependencies")continue;l[c]=t.deepCopy(i[c],{})}l=t.deepCopy(n.constraints,l);var h=u.validateProperty(e,l,s,o);a=a&&h.valid}}),!0},error:"{ path } unmatched dependency { schema.dependencies }. Value provided : { value|json }"},format:{schema:{type:"string"},test:function(e,t,n,r,i){return!e&&!n.required?!0:t=="array"||t=="object"?!0:this.lexic.__defaultPattern[n.format]?this.lexic.__defaultPattern[n.format].test.apply(this,[e,t,n,r,i,i+".format"]):(new RegExp(n.format)).test(String(e))},error:"{ path } unmatched format { schema.format }. Value provided : { value }"},pattern:{schema:{type:"string"},test:function(e,t,n,r,i){return!e&&!n.required?!0:t=="array"||t=="object"?!0:this.lexic.__defaultPattern[n.pattern]?this.doTest(this.lexic.__defaultPattern[n.pattern],e,t,n,r,i,i+".pattern"):(new RegExp(n.pattern)).searchInterpretable(String(e))},error:"{ path } unmatched pattern { schema.pattern }. Value provided : { value }"},minLength:{schema:{type:"integer"},test:function(e,t,n){return t!="array"&&t!="string"&&t!="integer"?!0:(!e||e=="")&&!n.required?!0:e.length>=n.minLength},error:"{ path } need to be at least { schema.minLength } length. Value provided : { value }"},maxLength:{schema:{type:"integer"},test:function(e,t,n){return(!e||e=="")&&!n.required?!0:t!="array"&&t!="string"&&t!="integer"?!0:e.length<=n.maxLength},error:"{ path } need to be at max { schema.minLength } length. Value provided : { value }"},minimum:{schema:{type:"number"},test:function(e,t,n){return t!="number"&&t!="integer"?!0:(!e||e=="")&&!n.required?!0:n.exclusiveMinimum?e>n.minimum:e>=n.minimum},error:"{ path } need to be at least { schema.exclusiveMinimum }. Value provided : { value }"},maximum:{schema:{type:"number"},test:function(e,t,n){return t!="number"&&t!="integer"?!0:!e&&!n.required?!0:n.exclusiveMaximum?e<n.maximum:e<=n.maximum},error:"{ path } need to be max { schema.exclusiveMaximum }. Value provided : { value }"},minItems:{schema:{type:"integer"},test:function(e,t,n){return!e&&!n.required?!0:t!="array"?!0:e.length>=n.minItems},error:"{ path } need to be at least { schema.minItems } long. Value provided : { value|json }"},maxItems:{schema:{type:"integer"},test:function(e,t,n){return(!e||e=="")&&!n.required?!0:t!="array"?!0:e.length<=n.maxItems},error:"{ path } need to be at max { schema.maxItems } long. Value provided : { value|json }"},required:{schema:{type:"boolean"},test:function(e,t,n){return typeof e!="undefined"},error:"{ path } is required and is missing."},"enum":{schema:{type:"array",items:{type:"string"}},test:function(e,t,n){if(typeof e!="undefined"&&e!=""||!!n.required){if(t!="string"&&t!="number"&&t!="integer")return!0;var r=!1;for(var i=0;i<n["enum"].length;++i)if(e==n["enum"][i]){r=!0;break}return r}return!0},error:"{ path } need to be equal to one of those values { schema.enum|join_coma }. Value provided : { value }"},disallow:{schema:{type:["array","string"],"enum":["string","array","number","integer","date","function","null","object"],items:{type:"string","enum":["string","array","number","integer","date","function","null","object"]}},test:function(e,t,n){if(!e&&!n.required)return!0;if(typeof disallow.push!="function")return n.disallow!==t;for(var r in n.disallow)if(n.disallow[r]==t)return!1;return!0},error:"{ path } need to be of different type than { schema.disallow|join_coma }. type provided : { type }"},divisibleBy:{schema:{type:"integer",minimum:1,absoluteMinimum:!0},test:function(e,t,n){return!e&&!n.required?!0:t!="number"&&t!="integer"?!0:e%n.divisibleBy==0},error:"{ path } ( value : { value }) need to be divisible by { schema.divisibleBy }."},uniqueItems:{schema:{type:"boolean"},test:function(e,n,r){if(n!="array")return!0;if(!e&&!r.required)return!0;if(!r.uniqueItems)return!0;var i=t.arrayFusion(e,e);return i.length==e.length},error:"each item need to be unique"},exclusiveMinimum:{schema:{type:"boolean"}},exclusiveMaximum:{schema:{type:"boolean"}},"default":{schema:{type:"any"}},title:{schema:{type:"string"}},description:{schema:{type:"string"}},id:{schema:{type:"string"}},readOnly:{schema:{type:"boolean"}},backgrounds:{schema:{type:["string","array"],items:{type:"string"},loadable:"direct"}},$schema:{schema:{type:"string",items:{type:"string"}},test:function(e,t,n){return console&&console.log("$schema isn't implemented in this validator and will not be implemented (due to his self definition method)"),!0}},$ref:{schema:{type:"string"}},links:{schema:{type:"array",items:{type:"object",properties:{rel:{type:"string",required:!0},href:{type:"string",required:!0},template:{type:"string"},targetSchema:{type:"string"},method:{type:"string","enum":["GET","PUT","POST","DELETE"]},enctype:{type:"string","default":"application/json"},schema:{type:"schema"}}}}},additionalProperties:{schema:{type:["false","schema"]},error:"no additional properties are allowed"},patternProperties:{schema:{type:"object",patternProperties:{"/.*/g":{type:"schema"}}}},properties:{schema:{type:"object",patternProperties:{"/.*/g":{type:"schema"}}}},contentEncoding:{schema:{type:"string"}},mediaType:{schema:{type:"string"}},additionalItems:{schema:{type:["false","schema"]},error:"no additional items are allowed"},items:{schema:{type:["array","schema"],items:{type:"schema"}}}};var u={divisibleBy:{$ommit:!0},mod:{schema:{type:"integer",minimum:1,absoluteMinimum:!0},test:function(e,t,n){return!e&&!n.required?!0:t!="number"&&t!="integer"?!0:e%n.mod==0},error:"need to be divisible by { schema.divisibleBy }"},maxProperties:{schema:{type:"integer",minimum:0},test:function(e,t,n){var r=0;for(var i in e){if(!e.hasOwnProperties(i))continue;r++}return r<=n.maxProperties},error:"need to have maximum { schema.maxProperties } properties"},minProperties:{schema:{type:"integer",minimum:0},test:function(e,t,n){var r=0;for(var i in e){if(!e.hasOwnProperties(i))continue;r++}return r>=n.minProperties},error:"need to have minimum { schema.maxProperties } properties"}},a={__defaultPattern:{retrievable:{test:function(t){return!t&&!schema.required?!0:e.parseRequest(t).store!=null},error:"need to be in 'retrievable' format. (see deep/deep-request/isRetrievable())"}},merge:{schema:{type:["string","boolean"]}},loadable:{schema:{type:"string","enum":["deep","direct","none"]}},preload:{schema:{type:"boolean",required:!1,"default":!0}},reloadable:{schema:{type:"boolean"}},"interpretation-deepness":{schema:{type:"string","enum":["deep","direct","none"]}}},f={type:{},notNull:{schema:{type:"boolean"},test:function(e,t,n){return!e&&!n.required?!0:n.notNull?e!==null:!0},error:"need to be not null"},absoluteMaximum:{schema:{type:"boolean"}},absoluteMinimum:{schema:{type:"boolean"}},minimum:{test:function(e,t,n){return!e&&!n.required?!0:t!="number"&&t!="integer"?!0:(n.absoluteMinimum&&(e=Math.abs(e)),n.exclusiveMinimum?e>n.minimum:e>=n.minimum)}},maximum:{test:function(e,t,n){return!e&&!n.required?!0:t!="number"&&t!="integer"?!0:(n.absoluteMaximum&&(e=Math.abs(e)),n.exclusiveMaximum?e<n.maximum:e<=n.maximum)}},needMatchingOn:{schema:{type:"string"},test:function(e,t,n){if(!e&&!n.required)return!0;var i=n.needMatchingOn;i[0]=="#"&&(i=i.substring(1));var s=r.query(this.rootValue,i);return s.length>0&&s[0]==e},error:"this field need to match { schema.needMatchingOn }"}},l={type:{"function":{test:function(e){return typeof e=="function"},error:"need to be a function"},"false":{test:function(e){return e===!1},error:"need to be false"},"true":{test:function(e){return e===!0},error:"need to be true"},date:{test:function(e){return e?typeof e.toUTCString=="function":!1},error:"need to be a date object"}}},c={__defaultPattern:{"coordination-number":{test:function(e,t,n){if(t!="string")return!0;if(!n.required&&!e)return!0;if(!e)return!1;var r=e+"";if(r.length!=10)return!1;var r=e.substring(4,5);return r=parseInt(r),r<60||r>91?!1:!0},error:"need to be in coordination-number format"},"personal-number":{test:function(e,t,n){if(t!="string")return!0;if(!n.required&&!e)return!0;if(!e)return!1;var r=e+"";if(r.length!=10)return!1;var r=e.substring(4,5);return r=parseInt(r),r<60||r>91?!1:!0},error:"need to be in personal-number format"}}};t.deepCopy(u,s.prototype.lexic),t.deepCopy(l,s.prototype.lexic),t.deepCopy(f,s.prototype.lexic),t.deepCopy(c,s.prototype.lexic);var h=new s;return s.convertStringTo=function(e,t){return h.convertStringTo(e,t)},s.validate=function(e,t,n){return h.validate(e,t,n)},s.getType=function(e){return h.getType(e)},s.partialValidation=function(e,t,n){return h.partialValidation(e,t,n)},s}}),define("deep/deep-query",["require"],function(t){return function(e){var t=e.rql,n=e.utils,r=Error,i=n.retrieveFullSchemaByPath,s=function(){};s.prototype.analyseEreg=function(t,r){var i=n.catchParenthesis(t),s=i.value,o="",u=i.rest,a=this;if(u[0]=="g"||u[0]=="i"){o=u[0];if(u[1]=="g"||u[1]=="i")o+=u[1]}return u=u.substring(o.length),r.push({type:"selector",value:s,options:o,handler:function(e){var t=[];for(var n in e.value){if(n=="_deep_entry")continue;if((new RegExp(this.value,this.options)).test(n)){var r=a.returnProperty(e,n);typeof r!="undefined"&&r!=null&&t.push(r)}}return t}}),u},s.prototype.analyse=function(t){var n=[],i=t;this.asked=t;while(i.length>0){var i=this.analyseMoves(i,n);if(n.length==0)throw new r("deep-queries need at least one move.",t);if(i.length==0)break;i=this.analyseSelector(i,n);if(i.length==0)break;i[0]=="?"&&(i=this.analyseRQL(i,n))}var s=this;return console.flags&&console.flags["deep-query"]&&(console.log("dq analayse : ",t),console.log(" : gives : "+JSON.stringify(n,null," "))),n},s.prototype.analyseRQL=function(r,i){if(r[0]!="?")return r;r=r.substring(1);if(r[0]=="("){var s=n.catchParenthesis(r);return i.push({type:"rql",value:s.value,handler:function(e){return t(e,s.value,{prefix:"value",fromDeepQuery:!0})}}),s.rest}var o=0,u="";while(r[o]!="/"&&o<r.length)u+=r[o++];return i.push({type:"rql",value:u,handler:function(e){try{var n=t(e,u,{prefix:"value",fromDeepQuery:!0})}catch(r){return console.log("deep-query : rql errors : ",r),[]}return n}}),r.substring(o)},s.prototype.analyseIndexAccess=function(t,n){var i="",s=0;while(t[s]!="/"&&t[s]!="?"&&s<t.length)i+=t[s++];var o=i.split(":"),u=this,a={type:"selector",handler:function(e){var t=this.start(e);if(t==-1)return[];if(this.end===null){var n=u.returnProperty(e,t);return n!=null&&typeof n!="undefined"?[n]:[]}var r=[];for(var i=t;i<=this.end(e);i+=this.step(e)){var n=u.returnProperty(e,i);n!=null&&typeof n!="undefined"&&r.push(n)}return r},start:null,end:null,step:function(e){return 1}},f=0,l=null;return o.forEach(function(e){if(e=="")f==0?l=function(e){return 0}:f==1?l=function(e){return e.value.length!==undefined?e.value.length-1:-1}:l=function(e){return 1};else if(e.substring(0,8)=="@.length"){var i=e.substring(8);if(i.length==0||i[0]!="-")throw new r("when you use @.length : you could only use minus '-' operator followed by an integer.",t,n);var s=parseInt(i.substring(1));if(isNaN(s))throw new r("when you use @.length : you could only use minus '-' operator followed by an integer.",t,n);l=function(e){if(e.value.length!==undefined){var t=Math.min(s,e.value.length);return t-s}return-1}}else{var o=parseInt(e);if(isNaN(o))throw new r("bad index : index unknown",t,n);l=function(e){return o}}f==0?a.start=l:f==1?a.end=l:a.step=l,f++}),n.push(a),t.substring(s)},s.prototype.analyseUnionAccess=function(t,n){if(t[0]!="[")throw new r("union access need to start with '['.",t,n);var i="",s=this,o=1;while(t[o]!="]"&&o<t.length)i+=t[o++];var u=i.split(",");if(u.length==0)return n.push({type:"selector",value:"*",handler:function(e){return self.returnAllProps(e)}}),t.substring(o+1);var a={type:"selector",selectors:[],handler:function(e){var t=[];return this.selectors.forEach(function(n){var r=n.handler(e);r&&(t=t.concat(r))}),t}};return u.forEach(function(e){s.analyseSelector(e,a.selectors,!0)}),n.push(a),t.substring(o+1)},s.prototype.createEntry=function(t,n){var r=n.path;r[r.length-1]=="/"?r+=t:r+="/"+t;var s=null;return n.schema&&(s=i(n.schema,t,"/")),this.cache[r]={_isDQ_NODE_:!0,root:n.root,value:n.value[t],path:r,key:t,ancestor:n,schema:s,depth:n.depth+1}},s.prototype.returnProperty=function(t,n){if(n=="_deep_entry")return null;if(typeof t.value=="string"&&n!=="length")return null;var r=t.value;return r&&typeof r[n]!="undefined"?t=this.createEntry(n,t):t=null,t},s.prototype.returnAllProps=function(t){if(typeof t.value=="string")return[];var n=t.value,r=[];for(var i in n){if(i=="_deep_entry"||i=="_deep_shared_")continue;if(!n.hasOwnProperty(i))continue;var s=this.createEntry(i,t);typeof s!="undefined"&&r.push(s)}return r},s.prototype.returnRecursiveProps=function(t){if(typeof t.value=="string")return[];var n=t.value,r=[],i=this;for(var s in n){if(!n.hasOwnProperty(s))continue;if(s=="_deep_entry")continue;var o=i.createEntry(s,t);typeof o!="undefined"&&r.push(o),typeof n[s]=="object"&&(r=r.concat(i.returnRecursiveProps(o)))}return r},s.prototype.analyseSelector=function(t,n,i){var s=0,o=this;if(t.length==0)return n.length>1&&n[n.length-1].slashes=="//"?t:(i?n.push({type:"selector",value:"*",handler:function(e){return o.returnAllProps(e)}}):n.push({type:"selector",value:"!",handler:function(e){return e?[e]:[]}}),t);if(t[0]=="?"){if(i)throw new r("you couldn't have '?' (rql) in an union of selectors.",t,n);return n[n.length-1].slashes=="//"?t:(n.push({type:"selector",value:"!",handler:function(e){return e?[e]:[]}}),t)}if(t[0]=="!")return n.push({type:"selector",value:"!",handler:function(e){return e?[e]:[]}}),t.substring(1);if(t[0]=="(")return this.analyseEreg(t,n);if(/^[0-9]/.test(t[0])||t[0]=="@"||t[0]==":")return this.analyseIndexAccess(t,n);if(t[0]=="["){if(i)throw new r("you couldn't have union in union of selectors."+this.currentQuery);return this.analyseUnionAccess(t,n)}var u="";while(t[s]!="/"&&t[s]!="?"&&s<t.length)u+=t[s++];return u=="*"?n.length>0&&n[n.length-1].slashes=="//"?t.substring(s):(n.push({type:"selector",value:"*",handler:function(e){return o.returnAllProps(e)}}),t.substring(s)):(n.push({type:"selector",value:u,handler:function(e){var t=o.returnProperty(e,u);return t!=null&&typeof t!="undefined"?[t]:[]}}),t.substring(s))},s.prototype.analyseMoves=function(t,n){var i=[],s="",o=0;while(o<t.length&&(t[o]=="."||t[o]=="/")){while(t[o]=="/")s+="/",o++;if(s.length>0){if(s.length>2)throw new r("bad move : ",t);i.push(s),s=""}while(t[o]==".")s+=".",o++;if(s.length>0){if(s.length>3)throw new r("bad move : ",t);i.push(s),s=""}}var u=i[i.length-1];if(!u)throw new r("deepQuery : missformed query : "+this.asked);u[0]=="."&&(o-=u.length);while(i.length>0){var a={type:"move",points:null,slashes:null},f=i.shift();f[0]=="."&&(a.points=f,f=i.shift());if(f!="/"&&f!="//")throw new r("bad move : "+JSON.stringify(t)+" - "+f);a.slashes=f,n.push(a)}return t.substring(o)},s.prototype.doMove=function(t,n,i){var s=[],o=t,u=this;return n.forEach(function(e){if(o.points)switch(o.points){case".":s.push(e);break;case"..":e.ancestor&&s.push(e.ancestor);break;case"...":var t=e;while(t.ancestor)s.push(t.ancestor),t=t.ancestor;break;default:throw new r("bad move : ",o)}o.points||(i?s.push(u.root):s.push(e)),o.slashes=="//"&&(s=s.concat(u.returnRecursiveProps(e)))}),s},s.prototype.query=function(t,i,o){if(typeof t!="object"||!t)return[];this.currentQuery=i,o=o||{};if(!this.cache||!o.keepQueryCache)this.cache={};var u=null;i[0]==="#"&&(i=i.substring(1)),t._isDQ_NODE_==1?(this.root=this.cache["/"]=t.root||t,u=[t]):t._deep_entry?(this.root=this.cache["/"]=t._deep_entry.root,u=[t._deep_entry]):(this.root=this.cache["/"]=s.createRootNode(t,o.schema),u=[this.cache["/"]]),u[0].root=this.root,this.straightQuery=!1,o.allowStraightQueries!==!1&&!i.match(/(\?)|(\/\/)|(\[)|(\()|(\*)/gi)&&(this.straightQuery=!0);var a=this.analyse(i);if(a.length==0||a[0].type!="move")throw new r("query need to start with move : "+i);var f=this,l=!0;while(a.length>0){var c=a.shift();switch(c.type){case"move":u=f.doMove(c,u,l);break;case"selector":var h=[],p=u.length;for(var d=0;d<p;++d){var v=u[d],m=c.handler(v);m&&m.length>0&&(h=h.concat(m))}u=h;break;case"rql":u=c.handler(u)}l=!1}u=n.arrayUnique(u,"path");if(o.resultType=="full")return this.straightQuery?u.shift():u;var g=[],p=u.length;for(var d=0;d<p;++d)g.push(u[d].value);return this.straightQuery?g.shift():g};var o=null;return s.query=function(t,n,r){return o||(o=new s),o.query(t,n,r)},s.firstObjectWithProperty=function(t,n){t._isDQ_NODE_||(t=s.createRootNode(t,{}));var r=t.value;if(r[n])return t;var i=[],o=function(t){var r=t.value;if(typeof r!="object"||!r)return!1;i.push(t);if(r[n])return!0;var u=!1;if(r instanceof Array){var a=0;u=r.some(function(e){return typeof e=="object"?o(s.createEntry(a++,t)):!1})}else for(var f in r){if(!r.hasOwnProperty(f)||f=="_deep_entry"||typeof r[f]!="object")continue;u=o(s.createEntry(f,t));if(u)break}return u?!0:(i.pop(),!1)},u=o(t);return u?i.pop():null},s.objectsWithProperty=function(t,n,r){var i=[],s=null,o=[{value:t,path:"/"}],u=!0;while(o.length>0){s=o.pop();var a=s.value;if(!a)continue;a[n]&&(!u||!r)&&i.push(a),u&&(u=!1);var f=[];if(a.forEach){var l=a.length;for(var c=0;c<l;++c){var h=a[c];typeof h=="object"&&f.unshift({path:s.path+c+"/",value:h})}}else for(var c in a){var h=a[c];if(c=="_deep_entry"||typeof h!="object"||c==n||!a.hasOwnProperty(c)||typeof jQuery!="undefined"&&h instanceof jQuery)continue;f.unshift({path:s.path+c+"/",value:h})}f.length>0&&(o=o.concat(f))}return i},s.preorder=function(t){var n=[],r=null,i=[{value:t,path:"/"}];while(i.length>0){r=i.pop();var s=r.value;n.push(r.path);var o=[];if(s.forEach){var u=s.length;for(var a=0;a<u;++a){var f=s[a];typeof f=="object"&&o.unshift({path:r.path+a+"/",value:f})}}else for(var a in s){var f=s[a];if(a=="_deep_entry"||typeof f!="object")continue;o.unshift({path:r.path+a+"/",value:f})}o.length>0&&(i=i.concat(o))}return n},s.inorder=function(t){var n=[],r=null,i=[{value:t,path:"/"}];while(i.length>0){r=i.shift();var s=r.value;n.push(r.path);if(s.forEach){var o=s.length;for(var u=0;u<o;++u){var a=s[u];typeof a=="object"&&i.push({path:r.path+u+"/",value:a})}}else for(var u in s){var a=s[u];if(u=="_deep_entry"||typeof a!="object")continue;i.push({path:r.path+u+"/",value:a})}}return n},s.createEntry=function(t,n){var r=n.path;r[r.length-1]=="/"?r+=t:r+="/"+t;var s=null;return n.schema&&(s=i(n.schema,t,"/")),{_isDQ_NODE_:!0,root:n.root,value:n.value[t],path:r,key:t,ancestor:n,schema:s,depth:n.depth+1}},s.createRootNode=function(t,n,r){r=r||{};var i={_isDQ_NODE_:!0,value:t,path:"/",uri:r.uri||null,key:null,ancestor:null,schema:n||{},depth:0};return i.root=i,i},s}}),define("deep/deep-compose",["require","exports","module"],function(e,t,n){return function(e){function n(t,n){return function(){var i=this,s=arguments,o=e.Deferred(),u=t.apply(this,s);if(typeof u=="undefined"){u=n.apply(i,s);if(typeof u=="undefined")return u;if(!u.then)return u;e.when(u).done(function(e){o.resolve(e)}).fail(function(e){o.reject(e)})}else if(u&&!u.then){u=n.apply(i,[u]);if(typeof u=="undefined")return u;if(!u.then)return u;e.when(u).done(function(e){o.resolve(e)}).fail(function(e){o.reject(e)})}else e.when(u).done(function(t){var r=s;typeof t!="undefined"&&(r=[t]),t=n.apply(i,r);if(typeof t=="undefined")return o.resolve(t);if(!t.then)return o.resolve(t);e.when(t).then(function(e){o.resolve(e)},function(e){o.reject(e)})}).fail(function(e){o.reject(e)});return o.promise()}}var t=function(e){this.stack=e||[]};t.prototype={before:function(t){var r=function(r){return n(t,r)};return this.stack.push(r),this},around:function(t){var n=function(n){return t(n)};return this.stack.push(n),this},after:function(t){var r=function(r){return n(r,t)};return this.stack.push(r),this},fail:function(n){var r=function(r){return function(){var t=this,i=arguments;return e.when(r.apply(this,i)).fail(function(e){return n.apply(t,[e])})}};return this.stack.push(r),this},done:function(n){var r=function(r){return function(){var t=this,i=arguments;return e.when(r.apply(this,i)).done(function(e){return n.apply(t,[e])})}};return this.stack.push(r),this},replace:function(t){var n=function(n){return t};return this.stack.push(n),this},parallele:function(n){var r=function(t){return function(){var i=arguments,s=[n.apply(this,i),t.apply(this,i)];return e.all(s)}};return this.stack.push(r),this}};var r=function(e){e=e||new t;var n=function(){return i.wrap(function(){},e).apply(this,arguments)};return n.decorator=e,n.after=function(r){return e.after(r),n},n.before=function(r){return e.before(r),n},n.fail=function(r){return e.fail(r),n},n.done=function(r){return e.done(r),n},n.around=function(r){return e.around(r),n},n.parallele=function(r){return e.parallele(r),n},n.replace=function(r){return e.replace(r),n},n.createIfNecessary=function(t){return n.decorator.createIfNecessary=typeof t=="undefined"?!0:t,n},n.ifExists=function(t){return n.decorator.ifExists=typeof t=="undefined"?!0:t,n},n.condition=function(t){return n.condition=t,n},n},i={Classes:function(){function n(){for(var n in t){var r=t[n];if(typeof r=="function"){var i=r.apply(this,arguments);typeof i=="object"&&e.utils.up(i,this)}}}var t=arguments,r={};for(var i in t){var s=t[i];typeof s=="function"?s.prototype&&e.utils.up(s.prototype,r):e.utils.up(s,r)}return n.prototype=r,n},Decorator:t,cloneStart:function(n){var i=n.decorator.stack.concat([]),s=new t(i);return s.ifExists=n.decorator.ifExists,s.createIfNecessary=n.decorator.createIfNecessary,r(s)},wrap:function(t,n){var r=t;return n.stack.forEach(function(e){r=e(r)}),r},createIfNecessary:function(){var t=r();return t.decorator.createIfNecessary=!0,t},ifExists:function(){var t=r();return t.decorator.ifExists=!0,t},condition:function(t){var n=r();return n.decorator.condition=t,n},up:function(n,r){if(typeof r!="function"||typeof n!="function")throw new Error("Composer.collide : you could only apply function together");return!!r.decorator&&r.decorator instanceof t?n.decorator&&n.decorator instanceof t?(n.decorator.stack=n.decorator.stack.concat(r.decorator.stack),n):i.wrap(n,r.decorator):r},bottom:function(n,r){if(typeof r!="function"||typeof n!="function")throw new Error("Composer.collide : you could only apply function together");return!!r.decorator&&r.decorator instanceof t?n.decorator&&n.decorator instanceof t?(r.decorator.stack=n.decorator.stack.concat(r.decorator.stack),r):i.wrap(n,r.decorator):r},around:function(t){return r().around(t)},after:function(t){return r().after(t)},before:function(t){return r().before(t)},fail:function(t){return r().fail(t)},done:function(t){return r().done(t)},parallele:function(t){return r().parallele(t)},replace:function(t){return r().replace(t)}};return i.sequence=function(t,n){if(!t||t.length===0)return n;var r=t.shift(),i=e.Deferred(),s={},o=function(u){e.when(u).then(function(e){if(t.length===0)return typeof e=="undefined"&&(e=n,n.length==1&&(e=n[0])),i.resolve(e),e;typeof e=="undefined"?e=n:e=[e],r=t.shift(),o(r.apply(s,e))},function(e){!i.rejected&&!i.resolved&&!i.canceled&&i.reject(e)})};return o(r.apply(s,n)),i.promise()},i}}),define("deep/deep-collider",["require"],function(e){return function(e){return{wrap:function(e,t){var n=function(n,r,i){return e(t(n,r,i),r,i)};return n._deep_collider=!0,n},copyTo:function(e,t){var n=function(n,r,i){return utils.setValueByPath(e,t,n),n};return n._deep_collider=!0,n},around:function(e){var t=function(t,n,r){return e(t)};return t._deep_collider=!0,t},replace:function(e){var t=function(t,n,r){return n[r]=e,e};return t._deep_collider=!0,t},log:function(){var e=function(e){return console.log("deep.collider : log : ",e),e};return e._deep_collider=!0,e},validate:function(e){var t=function(t){var n=validator.validate(t,e);if(!n.valid)throw new Error(n);return t};return t._deep_collider=!0,t},remove:function(){var e=function(e,t,n){return delete t[n],undefined};return e._deep_colliderRemove=!0,e},assert:{isTrue:function(){return function(e){return console.assert(e===!0),e}},isFalse:function(){var e=function(e){return console.assert(e===!1),e};return e._deep_collider=!0,e},equal:function(e){var t=function(t){return t==e};return t._deep_collider=!0,t},notEqual:function(e){var t=function(t){return t!=e};return t._deep_collider=!0,t},isNumber:function(){var e=function(e){return!isNaN(e)&&isFinite(e)};return e._deep_collider=!0,e}},array:{reverse:function(){var e=function(e){return typeof e.reverse=="function"?e.reverse():e};return e._deep_collider=!0,e},remove:function(e){var t=function(t,n,r){if(t&&t.forEach)for(var i=0;i<t.length;i++)if(t[i]==e){t=t.slice(i,i+1);break}n[r]=t};return t._deep_collider=!0,t}},string:{},number:{},object:{replace:function(e){var t=function(){return e};return t._deep_collider=!0,t},appendProperty:function(e,t){var n=function(n,r,i){return n[e]=t,n};return n._deep_collider=!0,n}},"boolean":{},func:{}}}}),define("deep/deep-errors",["require"],function(e){return function(e){return e.errors={Internal:function(e,t,n){var r=new Error(e,t,n);return r.status=500,r},PreconditionFail:function(e,t,n,r){var i=new Error(e);return i.status=412,i.report=t,i},NotFound:function(e,t,n,r){var i=new Error(e);return i.status=404,i.report=t,i},Forbidden:function(e,t,n,r){var i=new Error(e);return i.status=403,i.report=t,i},Range:function(e,t,n,r){var i=new Error(e);return i.status=416,i.report=t,i},Assertion:function(e,t,n,r){var i=new Error("AssertionError : "+e);return i.status=412,i.report=t,i},Mode:function(e,t,n,r){var i=new Error("ModeError : "+e);return i.status=500,i.report=t,i},Watch:function(e,t,n,r){var i=new Error("FileWatchError : "+e);return i.status=500,i.report=t,i},Store:function(e,t,n,r){var i=new Error("StoreError : "+e);return i.status=400,i.report=t,i},Protocole:function(e,t,n,r){var i=new Error("ProtocoleError : "+e);return i.status=400,i.report=t,i},OCM:function(e,t,n,r){var i=new Error("OCMError : "+e);return i.status=403,i.report=t,i},Post:function(e,t,n,r){var i=new Error("PostError : "+e);return i.status=400,i.report=t,i},Put:function(e,t,n,r){var i=new Error("PutError : "+e);return i.status=400,i.report=t,i},Patch:function(e,t,n,r){var i=new Error("PatchError : "+e);return i.status=400,i.report=t,i},Delete:function(e,t,n,r){var i=new Error("DeleteError : "+e);return i.status=400,i.report=t,i},RPC:function(e,t,n,r){var i=new Error("RPCError : "+e);return i.status=400,i.report=t,i}},e}}),define("deep/deep-stores",["require"],function(e){return function(t){typeof requirejs!="undefined"&&(requirejs.onError=function(e){console.log("requirejs OnError : "+e),console.log(e.requireType),e.requireType==="timeout"&&console.log("modules: "+e.requireModules)}),t.extensions=[],t.store=function(e){return t({}).store(e)},t.Store=function(e){this.protocole=e,e&&t.protocole(e,this),this._deep_store_=!0},t.Store.prototype={_deep_store_:!0,wrap:function(){var e=this;return function(){return e}}};var n={id:"id123",title:"hello",order:2},r={id:"id123",order:2,otherVar:"yes"},i={id:"id123",order:4,otherVar:"yes",newVar:!0};return t.Store.prototype.runTests=function(){function e(e){var n=t.query(e.tests,"./*");return t.utils.series(n,e).fail(function(e){return console.log("GENERIC STORE TEST FAILED : ",e),e}).done(function(e){console.log("GENERIC STORE TEST PASSED !! : ",e)})}return console.log("deep.Store.runTests"),e(this)},t.Store.prototype.tests={base:function(){return console.log("deep.Store.base tests"),t.store(this).post(n).equal(n).get("id123").equal(n).put(r).equal(r).get("id123").equal(r).patch({order:4,newVar:!0,id:"id123"}).equal(i).get("id123").equal(i).get("?order=4").equal([i])},del:function(){console.log("deep.Store.del tests");var e=!1;return t.store(this).del("id123").done(function(t){e=!0}).get("id123").fail(function(t){if(e&&t.status==404)return!0})}},t.store.Collection=t.compose.Classes(t.Store,function(e,n,r,i){n&&(this.collection=n),r&&(this.schema=r),i&&t.utils.up(i,this)},{init:t.compose.parallele(function(){var e=this;if(typeof this.collection=="string"||typeof this.schema=="string")return t(this).query("./[collection,schema]").load().done(function(t){return e})}),get:function(e,n){n=n||{};var r="",i=!1;e?e[0]=="*"?(r="./"+e,i=!0):e[0]=="?"?(r="./*"+e,i=!0):r="./*?id="+e:(r="./*",i=!0);var s=this.collection;this.collection._deep_ocm_&&(s=this.collection());var o=t.query(s,r);return!i&&o instanceof Array&&(o=o.shift()),typeof o=="undefined"?t.when(t.errors.NotFound()):t.when(o)},put:function(e,n){n=n||{};var r=n.id||e.id;if(!r)return t.when(t.errors.Store("Collection store need id on put"));var i=this.collection;this.collection._deep_ocm_&&(i=this.collection());var s=t.query(i,"./*?id="+r,{resultType:"full"});return s?(s=s.shift(),s.value=e,s.ancestor&&(s.ancestor.value[s.key]=s.value),t.when(s.value)):t.when(t.errors.NotFound("no items found in collection with : "+r))},post:function(e,n){n=n||{},n.id=n.id||e.id,n.id||(e.id=n.id="id"+(new Date).valueOf());var r=this.collection;this.collection._deep_ocm_&&(r=this.collection());var i=t.query(r,"./*?id="+e.id);return i&&i.length>0?t.when(t.errors.Store("deep.store.Collection.post : An object has the same id before post : please put in place : object : ",e)):(r.push(e),t.when(e))},del:function(e,n){var r=this.collection;this.collection._deep_ocm_&&(r=this.collection());var i=t(r).remove("./*?id="+e).done();return i&&(i=i.shift()),t.when(i)},range:function(e,n){var r=this.collection;return this.collection._deep_ocm_&&(r=this.collection()),t(r).range(e,n).store(this)}}),t.store.Collection.create=function(e,n,r,i){return new t.store.Collection(e,n,r,i)},t.store.Object=t.compose.Classes(t.Store,function(e,n,r,i){n&&(this.root=n),r&&(this.schema=r),i&&t.utils.up(i,this)},{get:function(e,n){var r=this.root||this;return r._deep_ocm_&&(r=r()),e[0]=="."||e[0]=="/"?t.when(t.query(r,e)):t.when(t.query(r,"./"+e))},put:function(e,n){n=n||{};var r=this.root||this;r._deep_ocm_&&(r=r());var i=n.id;if(!i)return t.when(t.errors.Store("QuerierStore need id on put"));var s=t.query(r,i,{resultType:"full"});return s?(s=s.shift(),s.value=e,s.ancestor&&(s.ancestor.value[s.key]=e),t.when(s.value)):t.when(t.errors.NotFound("QuerierStore.put : no items found in collection with : "+i))},post:function(e,n){n=n||{};var r=this.root||this;r._deep_ocm_&&(r=r());var i=e.id||n.id,s=n.schema||this.schema,o=t.query(r,i);return o&&o.length>0?t.when(t.errors.Store("deep.store.Object.post : An object has the same id before post : please put in place : object : ",e)):(t(r).setByPath(i,e),t.when(e))},del:function(e){var n=[],r=this.root||this;return r._deep_ocm_&&(r=r()),e[0]=="."||e[0]=="/"?t(r).remove(e).done(function(e){n=e}):t(r).remove("./"+e).done(function(e){n=e}),n&&(n=n.shift()),t.when(n)}}),t.store.Object.create=function(e,n,r){return new t.store.Object(e,n,r)},t.getStoreHandler=function(e){var n={method:"get",store:null};if(e&&e._deep_store_)n.store=e;else if(t.protocoles[e])n.store=t.protocoles[e];else{var r=e.split(".");n.store=t.protocoles[r.shift()];if(!n.store)return t.when(t.errors.Store("no store found with : "+e));n.method=r.shift();if(!n.store[n.method])return t.when(t.errors.Store("no method found in store found with : "+e))}return n.store._deep_ocm_&&(n.store=n.store()),typeof n.store=="function"&&(n.store={get:n.store}),n.store.init?t.when(n.store.init()).done(function(){return n}):t.when(n)},t.parseRequest=function(e,n){var r=e.substring(0,50).indexOf("::"),i=null,s=e,o=null;r>-1&&(i=e.substring(0,r),s=e.substring(r+2));if(e[0]=="#"||i=="first"||i=="last"||i=="this")o=t.getStoreHandler(t.protocoles.dq);else if(!i){var u=t.extensions.some(function(e){if(!e.extensions)return;for(var t=0;t<e.extensions.length;++t){var n=e.extensions[t];if(s.match(n)){o=e.store;break}}return o?!0:!1});u&&(o=t.getStoreHandler(o))}else o=t.getStoreHandler(i,{noError:!0});var a={_deep_request_:!0,request:e,store:o,protocole:i,uri:s};return a},t.getAll=function(e,n){var r=[];return e.forEach(function(e){r.push(t.get(e,n))}),t.all(r)},t.get=function(e,n){if(!e||typeof e!="string"&&!e._deep_request_)return t.when(e);n=n||{};var r=e;typeof r=="string"&&(r=t.parseRequest(e,n));var i=null;if(!r.store&&!r.protocole)return t.when(e);var s=function(e){var i=e.store[e.method](r.uri,n);return n.wrap?t.when(i).done(function(e){return n.wrap.result?typeof n.wrap.result.push=="function"?n.wrap.result.push(e):n.wrap.result=[].concat(n.wrap.result):n.wrap.result=e,n.wrap}):i};return t.when(r.store).done(s)},t.protocoles={dq:{get:function(n,r){var i=r.entry;if(!i)return undefined;var s=i.root||i,o=n;typeof o=="string"&&(o=t.parseRequest(o)),o.uri[0]=="#"&&(o.uri=o.uri.substring(1));var u=null;return r=r||{},r.keepCache=!1,o.uri.substring(0,3)=="../"?(o.uri=(i.path!="/"?i.path+"/":"")+o.uri,u=t.query(s,o.uri,r)):o.uri[0]=="/"?u=t.query(s,o.uri,r):u=t.query(i,o.uri,r),u}},js:function(n,r){typeof n=="object"&&(n=n.uri);var i=t.Deferred();try{e([n],function(e){i.resolve(e)},function(e){i.reject(e)})}catch(s){i.reject(s)}return i.promise()},instance:function(e,n){return t.protocoles.js(e,n).done(function(n){return typeof n=="function"?new n:t.errors.Internal("deep.protocoles.instance  : could not instanciate : "+JSON.stringify(e))})}},t.protocole=function(e,n){return n?(t.protocoles[e]=n,n):t.protocoles[e]},t.protocole.SheetProtocoles={up:function(e,n){n=n||{};var r=this;return function(s){return n.allowStraightQueries=!1,n.resultType="full",t.when(r.get(e,n)).done(function(e){var r=[];return e&&e.forEach(function(e){var i=e;e._isDQ_NODE_&&(i=e.value);var o=t.utils.up(s,i,n.shema);e.ancestor&&(e.ancestor.value[e.key]=o),r.push(o)}),r})}},bottom:function(e,n){n=n||{};var r=this;return function(s){return n.allowStraightQueries=!1,n.resultType="full",t.when(r.get(e,n)).done(function(e){var r=[];return e&&e.forEach(function(e){var i=e;e._isDQ_NODE_&&(i=e.value);var o=t.utils.bottom(s,i,n.shema);e.ancestor&&(e.ancestor.value[e.key]=o),r.push(o)}),r})}},series:function(e,n){n=n||{};var r=this;return function(s){return n.allowStraightQueries=!1,n.resultType=null,t.when(r.get(e,n)).done(function(e){var n=[],r=null;if(e&&e.length>0){var i=t.Deferred(),o=function(){r?i.reject(r):i.resolve(n)},u=function(){var a=e.shift(),f=null;typeof s=="string"?typeof a[s]=="function"&&(f=a[s]()):f=s.apply(a);if(f instanceof Error)return r=f,o();f&&f.then?t.when(f).done(function(t){n.push(t),e.length>0?u():o()}).fail(function(e){i.reject(e)}):(n.push(f),e.length>0?u():o())};return u(),i.promise()}return n})}},parallele:function(e,n){n=n||{};var r=this;return function(s){return t.all(r.call(e,n)(s))}},call:function(e,n){n=n||{};var r=this;return function(s){return n.allowStraightQueries=!1,n.resultType=null,t.when(r.get(e,n)).done(function(e){var t=[];return e&&e.forEach(function(e){typeof s=="string"?typeof e[s]=="function"?t.push(e[s]()):t.push(undefined):t.push(s.apply(e))}),t})}},transform:function(e,n){n=n||{};var r=this;return function(s){return n.allowStraightQueries=!1,n.resultType="full",t.when(r.get(e,n)).done(function(e){var t=[];return e&&e.forEach(function(e){var t=e;e._isDQ_NODE_&&(t=e.value);var n=s(t);e.ancestor&&(e.ancestor.value[e.key]=n),n.push(n)}),t})}},equal:function(e,n){n=n||{};var r=this;return function(s){n.allowStraightQueries=!1,n.resultType=null;var o=[];return t.when(r.get(e,n)).done(function(e){var n=!0;return e&&(n=e.every(function(e){return t.utils.deepEqual(e,s)})),n||new Error("sheet equality failed")})}}},t.utils.bottom(t.protocole.SheetProtocoles,t.protocoles.dq),t.Chain.addHandle("store",function(e){var n=this,r=function(r,i){typeof e=="string"?(n._storeName=e,n._store=null):(n._storeName=e.name,n._store=e),t.chain.position(n,n._storeName)};return t.Store.extendsChain(n),r._isDone_=!0,t.chain.addInChain.apply(n,[r]),this}),t.Store.extendsChain=function(e){return e.range=function(e,n,r,i){var s=this,o=function(o,u){var a=function(o){var u=o.store;return u.range?t.when(u.range(e,n,r,i)).done(function(e){s._nodes=[t.Querier.createRootNode(e)]}):t.errors.Store("provided store doesn't have RANGE. aborting RANGE !")};return t.getStoreHandler(s._store||s._storeName).done(a)};return o._isDone_=!0,s.range=t.Chain.range,t.chain.addInChain.apply(this,[o]),s},e.get=function(e,n){var r=this;if(e=="?"||!e)e="";var i=function(i,s){var o=function(i){var s=i.store;return s.get?(e[0]=="*"&&(e=e.substring(1)),t.when(s.get(e,n)).done(function(n){r._success=n,r._nodes=[t.Querier.createRootNode(n,null,{uri:e})]})):t.errors.Store("provided store doesn't have GET. aborting GET !")};return t.getStoreHandler(r._store||r._storeName).done(o)};return i._isDone_=!0,t.chain.addInChain.apply(this,[i]),r.range=t.Chain.range,r},e.post=function(e,n){var r=this,i=function(i,s){var o=function(i){var s=i.store;return s.post?t.when(s.post(e||t.chain.val(r),n)).done(function(e){r._nodes=[t.Querier.createRootNode(e)]}):t.errors.Store("provided store doesn't have POST. aborting POST !")};return t.getStoreHandler(r._store||r._storeName).done(o)};return i._isDone_=!0,r.range=t.Chain.range,t.chain.addInChain.apply(this,[i]),r},e.put=function(e,n){var r=this,i=function(i,s){var o=function(i){var s=i.store;return s.put?t.when(s.put(e||t.chain.val(r),n)).done(function(e){r._nodes=[t.Querier.createRootNode(e)]}):t.errors.Store("provided store doesn't have PUT. aborting PUT !")};return t.getStoreHandler(r._store||r._storeName).done(o)};return i._isDone_=!0,r.range=t.Chain.range,t.chain.addInChain.apply(this,[i]),r},e.patch=function(e,n,r){var i=this,s=function(s,o){var u=function(s){var o=s.store;return o.patch?t.when(o.patch(e||t.chain.val(i),n,r)).done(function(e){i._nodes=[t.Querier.createRootNode(e)]}):t.errors.Store("provided store doesn't have PATCH. aborting PATCH !")};return t.getStoreHandler(i._store||i._storeName).done(u)};return s._isDone_=!0,i.range=t.Chain.range,t.chain.addInChain.apply(this,[s]),i},e.del=function(e,n){var r=this,i=function(i,s){var o=function(i){var s=i.store;if(!s.del)return t.errors.Store("provided store doesn't have DEL. aborting DELETE !");var o=t.chain.val(r);return t.when(s.del(e||o.id,n)).done(function(e){r._nodes=[t.Querier.createRootNode(e)]})};return t.getStoreHandler(r._store||r._storeName).done(o)};return i._isDone_=!0,r.range=t.Chain.range,t.chain.addInChain.apply(this,[i]),r},e.rpc=function(e,n,r,i){var s=this,o=function(o,u){var a=function(o){var u=o.store;return u.rpc?t.when(u.rpc(e,n,r,i)).done(function(e){s._nodes=[t.Querier.createRootNode(e)]}):t.errors.Store("provided store doesn't have RPC. aborting RPC !")};return t.getStoreHandler(s._store||s._storeName).done(a)};return o._isDone_=!0,s.range=t.Chain.range,t.chain.addInChain.apply(this,[o]),s},e.bulk=function(e,n,r){var i=this,s=function(s,o){var u=function(s){var o=s.store;return o.bulk?t.when(o.bulk(e,n,r)).done(function(e){i._nodes=[t.Querier.createRootNode(e)]}):t.errors.Store("provided store doesn't have BULK. aborting BULK !")};return t.getStoreHandler(i._store||i._storeName).done(u)};return s._isDone_=!0,i.range=t.Chain.range,t.chain.addInChain.apply(this,[s]),i},e},t.Shared=function(e){return e._deep_shared_=!0,e},t.mediaCache={cache:{},reloadablesUriDico:{},clearCache:function(){this.cache={}},remove:function(e){delete this.cache[e]},manage:function(e,t){return this.cache[t]=e,e}},t.store.CachedSheet={"dq.up::./get":t.compose.around(function(e){return function(n,r){r=r||{},t.utils.decorateUpFrom(this,r,["cache","cachePath"]);if(r.cache!==!1){r.cacheName=r.cacheName||r.cachePath+n;if(t.mediaCache.cache[r.cacheName])return t.mediaCache.cache[r.cacheName]}var i=e.call(this,n,r);return r.cache!==!1&&t.mediaCache.manage(i,r.cacheName),i}}),"dq.up::./[post,put,patch]":t.compose.around(function(e){return function(n,r){r=r||{},t.utils.decorateUpFrom(this,r,["cache","cachePath"]),r.id=r.id||n.id;if(!r.id)return t.errors.Post("node.fs store need id on post/put/patch : ",n);r.cacheName=r.cacheName||r.cachePath+r.id;var i=e.call(this,n,r);return r.cache!==!1&&t.mediaCache.manage(i,r.cacheName),i}}),"dq.up::./del":t.compose.around(function(e){return function(n,r){return r=r||{},t.utils.decorateUpFrom(this,r,["cache","cachePath"]),r.cacheName=r.cacheName||r.cachePath+n,t.mediaCache.remove(r.cacheName),e.call(this,n,r)}})},t.store.ObjectSheet={"dq.up::./!":{methods:{relation:function(e,t){return e.relation(t)}},patch:function(e,n){n=n||{},t.utils.decorateUpFrom(this,n,["baseURI"]),n.id=n.id||e.id;if(!n.id)return t.when(t.errors.Patch("json stores need id on PATCH"));n.id=(n.baseURI||"")+n.id;var r=this;return r.get(n.id,n).fail(function(e){return t.when(t.errors.Patch("object doesn't exists : please POST in place of PATCH. path : "+n.id,e))}).done(function(i){return i=t.utils.copy(i),t.utils.up(e,i),r.put(i,n)})},rpc:function(e,n,r,i){var s=this;return i=i||{},this.methods[e]?this.get(r).done(function(r){return r=t.utils.copy(r),n.unshift({call:function(e,n){return s.methods[e]?s.methods[e].apply(r,n):t.errors.RPC("no method found with : "+e+". Aborting rpc call !")},save:function(){return s.put(r)},relation:function(e){if(!s.schema)return t.errors.Store("no schema provided for fetching relation. aborting rpc.getRelation : relation : "+e);var n=t.query(s.schema,"/links/*?rel="+e).shift();if(!n)return t.errors.Store("("+s.name+") no relation found in schema with : "+e);var i=t.utils.interpret(n.href,r);return t.get(i)}}),s.methods[e].apply(r,n)}):t.when(t.errors.RPC("no method found with : "+e+". Aborting rpc call !"))},bulk:function(e,n){n=n||{};var r=this,i=[],s=e.every(function(e){return e.id||(e.id="rpc-id"+(new Date).valueOf()),r[e.method]?(n.id=e.to,e.method==="rpc"?i.push(r.rpc(e.body.method,e.body.args,e.to,n)):e.method.toLowerCase()==="get"||e.method.toLowerCase()==="delete"?i.push(r[e.method](e.to,n)):i.push(r[e.method](e.body,n)),!0):(i.push(t.errors.Store("method not found during buk update : method : "+e.method)),!1)});return s?t.all(i).done(function(t){var n=[],r=0;return t.forEach(function(t){var i=e[r++];n.push({from:i.to,body:t,id:i.id})}),n}):t.when(i.pop())}},"dq.up::./[post,put]":t.compose.around(function(e){return function(n,r){var i=this.schema;if(i){i._deep_ocm_&&(i=i());var s=t.validate(n,i);if(!s.valid)return t.when(t.errors.PreconditionFail(s))}return e.call(this,n,r)}})},t.utils.sheet(t.store.ObjectSheet,t.store.Collection.prototype),t.utils.sheet(t.store.ObjectSheet,t.store.Object.prototype),t}}),define("deep/deep-ocm",["require"],function(e){return function(e){return e.ocm=function(t,n,r,i){typeof t!="string"&&(i=r,r=n,n=t);var s={modeNode:i,layer:n||{},currentModes:null,compiled:{},multiMode:!0,compileModes:function(n,r){var i=this,s=null;return!this.multiMode&&n.length===1?s=this.layer[n[0]]||null:n.forEach(function(t){var n=i.layer[t];n&&(s=e.utils.up(n,s))}),s===null?(console.warn("OCM : no associate mode found with : ",n," for protocole : ",t),{}):s},init:r},o=function(){var t=Array.prototype.slice.apply(arguments);if(t.length===0||s.blocked)if(s.currentModes&&s.currentModes.length>0)t=s.currentModes;else if(s.modeNode&&e.ocm.modeNodes[s.modeNode])t=e.ocm.modeNodes[s.modeNode];else{if(!(e.context.mode&&e.context.mode.length>0))throw e.errors.OCM("You need to set a mode before using ocm objects : ",e.context);t=e.context.mode}var n=t;typeof t.join=="function"&&(n=t.join("."));if(s.compiled[n])return s.compiled[n];var r=s.compileModes(t,s.layer);return e.ocm.nocache||(s.compiled[n]=r),s.init&&s.init.call(r),r};return e.ocm.instances.push(o),t&&(o.name=t,e.protocoles[t]=function(n,r){return console.log("ocm protocole : ",t,n.uri,r),e.query(o(),n.uri,r)}),o._deep_ocm_=!0,o.multiMode=function(e){s.multiMode=e},o.modeNode=function(e){return s.blocked?o():(s.modeNode=e,o)},o.mode=function(e){return s.blocked?o():(e===null?s.currentModes=null:s.currentModes=Array.prototype.slice.apply(arguments),o())},o.block=function(e){s.block=!0,o.unblock=function(t){t===e&&(s.blocked=!1)}},o.unblock=function(e){},o.flatten=function(){return s.blocked?e.when(null):e(s.layer).flatten().done(function(){return o})},o.up=function(){var t=e(s.layer);return t.up.apply(t,arguments)},o.bottom=function(){var t=e(s.layer);return t.bottom.apply(t,arguments)},o},e.ocm.instances=[],e.ocm.nocache=!1,e.ocm.modeNodes={},e.mode=function(t){var n=t?Array.prototype.slice.apply(arguments):null;return e({}).mode(n)},e.Chain.addHandle("mode",function(t){var n=this,r=arguments,i=function(i,s){n._contextCopied||(e.context=n._context=e.utils.simpleCopy(n._context)),n._contextCopied=!0,t instanceof Array?n._context.mode=t:n._context.mode=t?Array.prototype.slice.apply(r):null};return i._isDone_=!0,e.chain.addInChain.apply(n,[i]),this}),e.generalMode=function(t){e.context=e.utils.simpleCopy(e.context),arguments.length>1?e.context.mode=Array.prototype.slice.apply(arguments):t instanceof Array?e.context.mode=t:e.context.mode=[t]},e}}),define("deep/deep",["require","./utils","./deep-rql","./deep-schema","./deep-query","./deep-compose","./deep-collider","./deep-errors","./deep-stores","./deep-ocm"],function(e){function o(e){var t=new deep.Promise;return t._start(e)}function u(e,t){var n=[];t&&(n=n.concat(e._nodes));var r=new deep.Chain({_root:e._root,_rethrow:e.rethrow,_nodes:n,_queried:e._queried,_error:e._error,_context:e._context,_success:e._success});return r._initialised=!0,r}function l(e,t,n){if(!e._isDQ_NODE_)throw new Error("deep.callFunctionFromValue need DQNode");var r=e.value;typeof n=="undefined"?n=[]:n instanceof Array||(n=[n]);var i;return r&&r[t]?(r._deep_entry=e,i=r[t].apply(r,n),i&&i.then?i.then(function(){delete r._deep_entry},function(){delete r._deep_entry}):delete r._deep_entry,i):i}function c(e,t,n){if(!e._isDQ_NODE_)throw new Error("deep.callFunctionFromValue need DQNode");var r=e.value;typeof n=="undefined"?n=[]:n instanceof Array||(n=[n]);if(!r)return undefined;r._deep_entry=e;var i=t.apply(r,n);return i&&i.then?i.then(function(){delete r._deep_entry},function(){delete r._deep_entry}):delete r._deep_entry,i}function h(e){function n(){return t.ancestor&&(t.ancestor[t.key]=t.value),e}function r(r){t.ancestor&&delete t.ancestor[t.key];var i=h(e);return i&&i.then?deep.when(i).done(n):n()}function i(e){var n=h(t);return n&&n.then?deep.when(n).done(r):r(t)}if(!e._isDQ_NODE_)throw deep.errors.Internal("you couldn't only extends backgrounds of query node.");var t=deep.Querier.firstObjectWithProperty(e,"backgrounds");if(!t)return e;var s=p(t);return s&&s.then?deep.when(s).done(i):i(t)}function p(e){if(!e._isDQ_NODE_)throw deep.errors.Internal("you couldn't only extends backgrounds of query node.");var t=this,r=e.value;if(r.backgrounds){var i=function(t){function s(e){var t=[],n=!1;return e.forEach(function(e){e&&e.backgrounds&&(t.push(i(e.backgrounds)),n=!0)}),n?deep.all(t).done(function(t){var n=[];return e.forEach(function(e){e&&e.backgrounds&&(n=n.concat(t.shift()),delete e.backgrounds),n.push(e)}),n}):e}var n=[],r=!1;return t.forEach(function(t){if(typeof t=="string"){var i=deep.get(t,{entry:e});n.push(i),i&&i.then&&(r=!0)}else n.push(t)}),r?deep.all(n).done(s):s(n)},s=r.backgrounds;delete r.backgrounds;var o=i(s);return o&&o.then?deep.when(o).done(function(r){return r.reverse(),r.forEach(function(t){n.bottom(t,e.value,e.schema)}),e}):(o.forEach(function(t){n.bottom(t,e.value,e.schema)}),e)}return e}deep=function(t,n,r){var i=new deep.Chain(r);try{typeof t=="string"&&(t=deep.get(t)),typeof n=="string"&&(n=deep.get(n));var s=function(t,n){var s=t;t&&t._isDQ_NODE_?(s=t.value,i._nodes=[t]):t&&t._deep_store_?(i._nodes=[deep.Querier.createRootNode({},r)],i.store(t),deep.Store.extendsChain(i)):t&&t._deep_entry?(s=t._deep_entry.value,i._nodes=[t._deep_entry]):i._nodes=[deep.Querier.createRootNode(t,n,r)],i._root=i._nodes[0],i._start(s,null)},o=null;t&&(t.then||t.promise)&&(o=[t,n]),o?deep.all(o).done(function(e){s(e[0],e[1])}).fail(function(e){i._nodes=null,i._start(null,e)}):s(t,n)}catch(u){console.log("internal chain start error : ",u),i._nodes=[deep.Querier.createRootNode({},n,r)],i._start(null,u)}return i};var t=e("./deep-errors")(deep);deep.compose=e("./deep-compose")(deep),deep.collider=e("./deep-collider")(deep),deep.rethrow=!1,deep.metaSchema={};var n=deep.utils=e("./utils")(deep);deep.rql=e("./deep-rql")(n).query;var r=deep.Querier=e("./deep-query")(deep);deep.Validator=e("./deep-schema")(deep),deep.validate=deep.Validator.validate,deep.partialValidation=deep.Validator.partialValidation,deep.isNode=typeof process!="undefined"&&process.versions&&process.versions.node,deep.query=r.query,deep.interpret=n.interpret,deep.context={},deep.globals={},deep.globalHaders={},deep.destructiveLoad=!1;var i=function(t){var n=this;if(n.deferred&&(n.deferred.rejected||n.deferred.resolved))throw deep.errors.Internal("you try to add handles in ended chain ! aborting and throw.");return n._queue.push(t),n._initialised&&!n._running&&!n._executing&&n._forceHandle(),this},s=function(){if(!this._initialised)return;var t=this;this.oldQueue&&(this._queue=this._queue.concat(this.oldQueue),delete this.oldQueue);if(t._queue.length>0){t._executing=!0;while(!t._running){var n=deep.context;try{n!==t._context&&(n&&n.suspend&&n.suspend(),deep.context=t._context,t._context&&t._context.resume&&t._context.resume());var r=t._queue.shift();if(t._error)while(r&&r._isDone_)r=t._queue.shift();else while(r&&r._isFail_)r=t._queue.shift();if(!r)break;t._running=!0;var i=r(t._success,t._error);i&&(i.then||i.promise)?deep.when(i).done(function(e){typeof e!="undefined"&&(t._success=e instanceof Error?null:e,t._error=e instanceof Error?e:null),t._running=!1,t._executing||t._forceHandle()}).fail(function(e){t._running=!1,t._success=null,t._error=e,t._executing||t._forceHandle()}):(t._running=!1,typeof i!="undefined"&&(t._success=i instanceof Error?null:i,t._error=i instanceof Error?i:null))}catch(s){var o="Internal chain error : rethrow ? "+t._rethrow;console.error(o,s),deep.utils.dumpError(s);if(t.rethrow)throw s;t._success=null,t._error=s,t._running=!1}finally{n!==t._context&&(t._context&&t._context.suspend&&t._context.suspend(),n&&n.resume&&n.resume(),deep.context=n),t.oldQueue&&(t._queue=t._queue.concat(t.oldQueue),delete t.oldQueue)}}t._executing=!1}};deep.promise=function(t){if(typeof t=="undefined"||t===null)return o(t);if(typeof t.then=="function"){var n=deep.Deferred();return t.then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise()}return typeof t.promise=="function"?t.promise():typeof t.promise=="object"?t.promise:o(t)},deep.promise.immediate=o,deep.when=deep.promise,deep.all=function(){var t=[];for(var n in arguments)t=t.concat(arguments[n]);if(t.length===0)return o([]);var r=deep.Deferred(),i=t.length,s=0,u=-1,a=[],f=!1;return t.forEach(function(e){if(r.rejected)return;var t=u+1;if(!e||!e.then&&!e.promise){if(e instanceof Error){f=!0,!r.rejected&&!r.resolved&&!r.canceled&&r.reject(e);return}a[t]=e,s++,s==i&&r.resolve(a)}else deep.when(e).then(function(e){if(e instanceof Error){!r.rejected&&!r.resolved&&!r.canceled&&r.reject(e);return}a[t]=e,s++,s==i&&r.resolve(a)},function(e){!r.rejected&&!r.resolved&&!r.canceled&&r.reject(e)});u++}),r.promise()},deep.Deferred=function(){return this instanceof deep.Deferred?(this._context=deep.context,this._promises=[],this._deep_deferred_=!0,this):new deep.Deferred},deep.Deferred.prototype={_deep_deferred_:!0,_promises:null,rejected:!1,resolved:!1,canceled:!1,_success:null,_error:null,resolve:function(t){if(this.rejected||this.resolved||this.canceled)throw new Error("DeepDeferred (resolve) has already been ended ! could not recolve anymore.");if(t instanceof Error)return this.reject(t);this._success=t,this.resolved=!0,this._promises.forEach(function(e){e._start(t)})},reject:function(t){if(this.rejected||this.resolved||this.canceled)throw new Error("DeepDeferred has already been ended ! could not reject anymore.");this._error=t,this.rejected=!0,this._promises.forEach(function(e){e._start(null,t)})},promise:function(){var t=new deep.Promise;return this.resolved||this.rejected||this.canceled?t._start(this._success,this._error):(this._promises.push(t),t)}},deep.Promise=function(t){t=t||{},this._context=deep.context,this._queue=[],this._deep_promise_=!0,this._running=!1,this._executing=!1,this._initialised=!1,this._rethrow=typeof t.rethrow!="undefined"?t.rethrow:deep.rethrow},deep.Promise.prototype={_forceHandle:s,_queue:null,_success:null,_error:null,_running:!1,_executing:!1,_initialised:!1,_start:function(t,n){return this._initialised=!0,this._success=t instanceof Error?null:t,this._error=t instanceof Error?t:n,this._forceHandle(),this},catchError:function(e){var t=this;if(t._initialised){var n=function(r,i){t._rethrow=typeof e!="undefined"?!e:!1};i.apply(this,[n])}else t._rethrow=typeof e!="undefined"?!e:!1;return this},pushHandlerTo:function(e){var t=this;if(t._initialised){var n=function(n,r){e.push(t)};i.apply(this,[n])}else e.push(t);return this},condition:function(e,t){var n=this,r=function(r,i){typeof e=="function"&&(e=e());if(!e)return;var s=function(e){n.oldQueue=n._queue,n._queue=[];var t=e.call(n,r,i);if(t===n)return;return t};return typeof t=="string"?deep.when(deep.get(t)).done(function(t){if(e)return s(t)}):s(t)};return i.call(this,r),this},done:function(t){if(!t)return this._success;var n=this,r=function(r,i){n.oldQueue=n._queue,n._queue=[];var s=t.apply(n,[r]);if(s===n)return;return s};return r._isDone_=!0,i.apply(this,[r])},fail:function(t){if(!t)return this._error;var n=this,r=function(r,i){n.oldQueue=n._queue,n._queue=[];var s=t.apply(n,[i]);if(s===n)return;return s};return r._isFail_=!0,i.apply(this,[r])},always:function(t){var n=this,r=function(r,i){n.oldQueue=n._queue,n._queue=[];var s=t.apply(n,[r,i]);if(s===n)return;return s};return i.apply(this,[r])},then:function(t,n){return t&&this.done(t),n&&this.fail(n),this},log:function(){var t=this,n=Array.prototype.slice.call(arguments),r=function(t,r){n.length===0&&(r?deep.debug?deep.utils.dumpError(r):r.report?n.push("deep.log : error : ("+r.status+"): ",r.message,r.report):n.push("deep.log : error : ("+r.status+"): ",r.message):n.push("deep.log : success : ",t)),n.forEach(function(e){console.log(e)})};return i.apply(this,[r])},delay:function(t){var n=this,r=function(e,n){var r=deep.Deferred();return setTimeout(function(){console.log("deep.delay.end : ",t),r.resolve(undefined)},t),r.promise()};return i.apply(this,[r])},context:function(e,t){var n=this,r=function(r,i){n._contextCopied||(deep.context=n._context=deep.utils.simpleCopy(n._context)),n._contextCopied=!0,n._context[e]=t};return t?(r._isDone_=!0,i.call(this,r)):e?n._context[e]:n._context},logContext:function(e){var t=this,n=function(r,i){e?console.log("deep.chain.context : ",t._context[e]):console.log("deep.chain.context : ",t._context)};return i.apply(this,[n])}},deep.BaseChain=function(t){t=t||{},this._rethrow=typeof t.rethrow!="undefined"?t.rethrow:deep.rethrow,this._deep_chain_=!0,this._context=t._context||deep.context,this._queue=[],this._queried=t._queried,this._nodes=t._nodes,this._success=t._success||null,this._error=t._error||null,this.positions=[],this._queried=!1,this.deferred=null};var a=function v(e){var t=this,v={branches:[],branch:function(){if(this._ended)throw deep.errors.Chain("Branching failed : brancher has already bean ended. Could not add branches any more.");var t=u(e,!0);return this.branches.push(t),t},promise:function(){return this._ended=!0,deep.all(this.branches)}};return v};deep.BaseChain.prototype={_nodes:null,promise:function(){return this.deferred||(this.deferred=deep.Deferred()),this._initialised&&this._queue.length===0&&(!this.oldQueue||this.oldQueue.length===0)&&!this._running&&!this._executing&&(this._error?this.deferred.reject(this._error):this.deferred.resolve(this._success)),this.deferred.promise()},_forceHandle:function(){var t=this;if(this.deferred&&(t.deferred.rejected||t.deferred.resolved||t.deferred.canceled))throw deep.errors.Internal("chain has already been ended ! could'nt execute it further.");s.apply(this);if(!this.deferred)return;t._queue.length===0&&!t._running&&(t._error?t.deferred.reject(t._error):t.deferred.resolve(t._success))},logValues:function(t,n){var r=this;n=n||{};var s=function(e,i){console.log(t||"deep.logValues : "," ("+r._nodes.length+" values)"),r._nodes.forEach(function(e){var t=e,r=null;e.value&&(r=e.value._deep_entry,delete e.value._deep_entry),n.full||(t=e.value),n.pretty&&(t=JSON.stringify(t,null," ")),console.log("	- entry : ("+e.path+") : ",t),r&&e.value&&(e.value._deep_entry=r)})};return i.apply(this,[s])},when:function(e){var t=this,n=function(t,n){return e};return n._isDone_=!0,i.apply(this,[n])},branches:function(t){var n=this,r=function(e,r){n.oldQueue=n.callQueue,n._queue=[];var i=t.call(n,a(n));if(i===n)return;return i};return r._isDone_=!0,i.call(this,r)}},deep.Chain=function(t){deep.BaseChain.call(this,t)},deep.Chain.prototype={},deep.utils.bottom(deep.Promise.prototype,deep.BaseChain.prototype),deep.utils.bottom(deep.BaseChain.prototype,deep.Chain.prototype),deep.Chain.addHandle=function(t,n){return deep.Chain.prototype[t]=n,deep.Chain};var f={interpret:function(t){var n=this,r=function(){var e=function(e){return deep.chain.transform(n,function(t){return deep.utils.interpret(t,e)})};return typeof t=="string"?deep.when(deep.get(t)).done(e):e(t)};return r._isDone_=!0,i.apply(this,[r]),this},deepLoad:function(t,n){var r=this;typeof n=="undefined"&&(n=!1);var s=function(e,i){var s=[],o=function(e){if(typeof e.value=="string"){var n=e.value;return t&&(n=deep.utils.interpret(n,t)),deep.when(deep.get(n,{})).done(function(e){return e})}if(typeof e.value!="function")return e.value;if(!e.ancestor)return e.value();e.ancestor.value[e.key]()},u=[];return r._nodes.forEach(function(e){var t=e;!n&&!deep.destructiveLoad&&(t=deep.utils.copy(e.value)),s.push(t&&t._isDQ_NODE_?t.value:t),u=u.concat(deep.query(t,".//*?or(_schema.type=string,_schema.type=function)",{resultType:"full"}))}),deep.when(deep.chain.transformNodes(u,o)).done(function(){return r._queried?s:s.shift()})};return s._isDone_=!0,i.apply(this,[s])},load:function(t,n){var r=this;typeof n=="undefined"&&(n=!1);var s=function(e,i){if(t)return typeof t=="string"?deep.get(t):typeof t=="function"?t():t;!r._queried&&r._nodes[0]&&r._nodes[0].value instanceof Array&&(r._nodes=deep.query(r._nodes[0],"./*",{resultType:"full"}),r._queried=!0);var s=[],o=function(e){return e.value?e.value.load?deep.when(l(e,"load")):typeof e.value=="string"?deep.when(deep.get(e.value,{entry:e})).done(function(t){return n||deep.destructiveLoad?(e.ancestor&&(e.ancestor.value[e.key]=t),e.value=t):t}):e.value:e.value};return r._nodes.forEach(function(e){s.push(o(e))}),deep.all(s).done(function(e){return console.log("load res : ",e),r._queried?e:e.shift()})};return s._isDone_=!0,i.apply(this,[s])},query:function(){var t=this,n=arguments,r=function(e,r){var i=[],s=[],o=!1;for(var u=0;u<n.length;++u){var a=n[u];a[0]==="?"&&(a="./*"+a);if(a[0]==="/"){var f=deep.query(t._root,a,{resultType:"full"});f&&f._isDQ_NODE_&&(o=!0),typeof f!="undefined"&&(i=i.concat(f))}else t._nodes.forEach(function(e){e=deep.query(e,a,{resultType:"full"}),e&&e._isDQ_NODE_&&(o=!0),typeof e!="undefined"&&(i=i.concat(e))})}return i.length>0?t._nodes=deep.utils.arrayUnique(i,"path"):t._nodes=[],n.length==1&&o?t._queried=!1:t._queried=!0,deep.chain.val(t)};return r._isDone_=!0,i.apply(t,[r])},select:function(e){var t=this;e instanceof Array||(e=[e]);var n=[];return t._nodes.forEach(function(t){e.forEach(function(e){n=n.concat(deep.query(t,e))})}),n},val:function(t){var n=this,r=function(e,r){return typeof t=="string"?deep.when(deep.get(t)).done(function(e){return d(e,deep.chain.val(n))}):d(t,deep.chain.val(n))};return r._isDone_=!0,t?(i.apply(this,[r]),this):deep.chain.val(n)},first:function(t){var n=this,r=function(e,r){var i=function(e){return e===!0?deep.chain.first(n,!0):d(e,deep.chain.first(n))};return typeof t=="string"?deep.when(deep.get(t)).done(i):i(t)};return r._isDone_=!0,t?(i.apply(this,[r]),this):deep.chain.first(n)},last:function(t){var n=this,r=function(e,r){var i=function(e){return e===!0?deep.chain.last(n,!0):d(e,deep.chain.last(n))};return typeof t=="string"?deep.when(deep.get(t)).done(i):i(t)};return r._isDone_=!0,t?(i.apply(this,[r]),this):deep.chain.last(n)},each:function(t){var n=this,r=function(){var e=function(e){return deep.all(deep.chain.each(n,e))};return typeof t=="string"?deep.when(deep.get(t)).done(e):e(t)};return r._isDone_=!0,i.apply(this,[r]),this},values:function(t){var n=this,r=function(e,r){return typeof t=="string"?deep.when(deep.get(t)).done(function(e){return d(e,deep.chain.values(n))}):d(t,deep.chain.values(n))};return r._isDone_=!0,t?(i.apply(this,[r]),this):deep.chain.values(n)},transform:function(t){var n=this,r=function(e,r){var i=function(e){return deep.chain.transform(n,e)};return typeof t=="string"?deep.when(deep.get(t)).done(i):i(t)};return r._isDone_=!0,i.apply(this,[r]),this},run:function(t,n){var r=this;n=n||[];var s=function(e){if(!t){if(typeof e.value!="function")return;return e.ancestor?l(e.ancestor,e.key,n):e.value(n||null)}return typeof t=="function"?c(e,t,n):typeof t=="string"?l(e,t,n):e},o=function(e,t){if(!r._queried)return r._nodes[0]?s(r._nodes[0]):undefined;var n=[];return r._nodes.forEach(function(e){n.push(s(e))}),deep.all(n)};return o._isDone_=!0,i.apply(this,[o]),this},exec:function(t,n){var r=this;n=n||[];var s=function(){return t.apply({},n)};return s._isDone_=!0,i.apply(this,[s]),this},reverse:function(){var t=this,n=function(e,n){if(t._nodes.length===0)return;if(t._queried){t._nodes.reverse();return}t._nodes[0].value instanceof Array&&t._nodes[0].value.reverse()};return n._isDone_=!0,i.apply(this,[n]),t},sort:function(){var t=arguments,n=this,r=function(e){var r=[];for(var i=0;i<t.length;i++){var s=t[i],o=s.charAt(0),u={attribute:s,ascending:!0};if(o=="-"||o=="+")o=="-"&&(u.ascending=!1),u.attribute=u.attribute.substring(1);n._queried&&(u.attribute="value"+(u.attribute?"."+u.attribute:"")),r.push(u)}return e.sort(function(e,t){for(var n,i=0;n=r[i];i++){if(n.attribute===""){if(e!=t)return n.ascending==e>t?1:-1;return}var s=deep.utils.retrieveValueByPath(e,n.attribute),o=deep.utils.retrieveValueByPath(t,n.attribute);if(s!=o)return n.ascending==s>o?1:-1}return 0}),n._queried?deep.chain.val(n):e},s=function(e,i){return t.length===0&&(t=["+"]),n._queried?r(n._nodes):n._nodes.length===0?[]:n._nodes[0].value instanceof Array?r(n._nodes[0].value):n._nodes[0].value};return s._isDone_=!0,i.apply(this,[s]),n},range:function(t,r){var s=this,o=function(e,i){var o=null;if(!s._queried){if(s._nodes.length===0)return n.createRangeObject(0,0,0);var u=s._nodes[0];return u.value instanceof Array?(o=n.createRangeObject(t,r,u.value.length),o.results=u.value=u.value.slice(o.start,o.end+1),o):(o=n.createRangeObject(0,0,1),o.results=[u.value],o)}return o=n.createRangeObject(t,r,s._nodes.length),s._nodes=s._nodes.slice(o.start,o.end+1),o.results=deep.chain.values(s),o};return o._isDone_=!0,i.apply(this,[o]),this},position:function(t,n){var r=this,s=function(e,i){deep.chain.position(r,t,n)};return s._isDone_=!0,i.apply(this,[s]),this},back:function(t,n){var r=this,s=function(e,n){var i=null;if(t){var s=r.positions.concat([]),o=!1;while(s.length>0){i=s.pop();if(i.name==t){o=!0;break}}s.length===0&&!o&&(i=null)}else i=r.positions[r.position.length-1];return i?(r._nodes=i.entries,r._store=i.store,r._queried=i.queried,i):deep.errors.Internal("chain handler error : no positions to go back with name : "+t)};return s._isDone_=!0,i.apply(this,[s]),this},parents:function(t){var n=this,r=function(){var e=[];return n._nodes.forEach(function(t){t.ancestor&&e.push(t.ancestor)}),e.length>0&&(e=deep.utils.arrayUnique(e,"path")),n._nodes=e,e.length===0&&t?deep.errors.Internal("deep.parents could not gives empty results"):deep.chain.values(n)};return r._isDone_=!0,i.apply(this,[r]),n},deep:function(t,n,r){var s=this,o=function(){return deep(t,n,r).done(function(e){s._nodes=this._nodes,s._root=this._root,s._success=this._success,s._queried=!1})};return o._isDone_=!0,i.apply(this,[o]),this},setByPath:function(t,r){var s=this,o=function(){var e=function(e){var r=[];return s._nodes.forEach(function(i){r.push(n.setValueByPath(i.value,t,e,"/"))}),r};return typeof r=="string"?deep.when(deep.get(r)).done(e):e(r)};return o._isDone_=!0,i.apply(this,[o]),this},sheet:function(){var t=Array.prototype.slice.call(arguments),r=this,s=function(){var e=[];return deep.when(deep.getAll(t)).done(function(i){return r._nodes.forEach(function(t){i.forEach(function(r){e.push(n.sheet(r,t,t.schema))})}),t.length==1?deep.when(e[0]):deep.all(e)})};return s._isDone_=!0,i.apply(this,[s]),this},up:function(){var t=Array.prototype.slice.call(arguments),r=this,s=function(){return deep.when(deep.getAll(t)).done(function(e){return r._nodes.forEach(function(t){e.forEach(function(e){t.value=n.up(e,t.value,t.schema),t.ancestor&&(t.ancestor.value[t.key]=t.value)})}),deep.chain.val(r)})};return s._isDone_=!0,i.apply(this,[s]),this},bottom:function(){var t=Array.prototype.slice.call(arguments);t.reverse();var r=this,s=function(){return deep.when(deep.getAll(t)).done(function(e){return r._nodes.forEach(function(t){e.forEach(function(e){t.value=n.bottom(e,t.value,t.schema),t.ancestor&&(t.ancestor.value[t.key]=t.value)})}),deep.chain.val(r)})};return s._isDone_=!0,i.apply(this,[s]),this},replace:function(t,n,r){var s=this,o=function(){function i(t){if(!t.ancestor)return;t.ancestor.value[t.key]=t.value=n,e.push(t)}var e=[],o=function(n){return s._nodes.forEach(function(e){var e=deep.query(e,t,{resultType:"full"});if(!e)return e;e._isDQ_NODE_?i(e):e.forEach(i)}),e};return typeof n=="string"?deep.when(deep.get(n,r)).done(o):o(n)};return o._isDone_=!0,i.apply(this,[o]),this},remove:function(t){var n=this,r=function(){function r(t){if(!t.ancestor)return;e.push(t),t.ancestor.value instanceof Array?t.ancestor.value.splice(t.key,1):delete t.ancestor.value[t.key]}var e=[];return n._nodes.forEach(function(e){var e=deep.query(e,t,{resultType:"full"});if(!e)return e;e._isDQ_NODE_?r(e):e.forEach(r)}),e};return r._isDone_=!0,i.apply(this,[r]),this},flatten:function(){var t=this,n=function(){var e=[];return t._nodes.forEach(function(t){var n=h(t);n&&n.then&&e.push(n)}),e.length===0?deep.chain.val(t):deep.all(e).done(function(){return deep.chain.val(t)})},r=function(){var e=[];return t._nodes.forEach(function(t){if(!t.value||typeof t.value!="object")return;if(t.value.backgrounds){var n=p(t);n&&n.then&&e.push(n)}}),e.length===0?n():deep.all(e).done(n)};return r._isDone_=!0,i.apply(this,[r]),this},equal:function(t){var r=this,s=function(){var e=deep.chain.val(r),i=n.deepEqual(e,t),s={equal:i,value:e,needed:t};return i?s:deep.errors.PreconditionFail("deep.equal failed ! ",s)};return s._isDone_=!0,i.apply(this,[s]),r},validate:function(t){var n=this,r=function(){var e=function(e){var t={valid:!0,reports:[]};return n._nodes.forEach(function(n){var r=deep.validate(n.value,e||n.schema||{});t.reports.push(r),r.valid||(t.valid=!1)}),t.valid?n._queried?t:t.reports.shift():deep.errors.PreconditionFail("deep.validate failed ! ",t)};return typeof t=="string"?deep.when(deep.get(t)).done(e):e(t)};return r._isDone_=!0,r._name="deep.Chain.validate",i.apply(this,[r]),this},assert:function(t){var n=this,r=function(e,r){var i=function(e){return e!==!0?deep.errors.Assertion("assertion failed"):!0},s=null;return typeof t=="function"?(n.oldQueue=n._queue,n._queue=[],s=t.call(n,e)):s=t,s&&(s.then||s.promise)?deep.when(s).done(i):i(s)};return r._isDone_=!0,i.apply(this,[r])},mapOn:function(t,n,r,s){var o=this,a=function(e,t,n,r){var i={};return e.forEach(function(e){if(e===null)return;var t=e[n];typeof i[t]!="undefined"?i[t]instanceof Array?i[t].push(e):i[t]=[i[t],e]:i[t]=e}),o._nodes.forEach(function(e){i[e.value[t]]&&(e.value[r||t]=i[e.value[t]])}),deep.chain.val(o)},f=function(e,i){if(o._nodes.length===0)return deep.chain.values(o);if(typeof t=="string"){var f=deep.parseRequest(t),l=u(o,!0),c=l.select("./"+n).join(","),h=r+"=in=("+c+")";return f.uri==="!"&&(f.uri=""),f.uri.match(/(\/\?)|^(\?)/gi)?f.uri+="&"+h:f.uri+="?"+h,f.store!==null?deep.when(f.store.get(f.uri)).done(function(e){return e=[].concat(e),a(e,n,r,s)}):deep.errors.Internal("deep.mapOn need array as 'what' : provided : "+JSON.stringify(t))}return a(t,n,r,s)};return f._isDone_=!0,i.apply(this,[f]),this},getRelations:function(){var t=this,n=Array.prototype.slice.apply(arguments),r=function(e,r){var i=[],s=[];return t._nodes.forEach(function(e){if(!e.schema||!e.schema.links)return;var t={value:e.value,schema:e.schema};s.push(t),deep.query(e.schema.links,"./*?rel=in=("+n.join(",")+")").forEach(function(n){var r=deep.utils.interpret(n.href,e.value),s=deep.parseRequest(r),o={rel:n,href:s};t[n]=o,i.push(deep.get(s,{defaultProtocole:"json",wrap:o}))})}),i.length==0?[e,r]:deep.all(i).done(function(e){return s})};return r._isDone_=!0,i.apply(this,[r]),this},mapRelations:function(t,n){n||(n=".");var r=this,s=[];for(var o in t)s.push(o);var u=function(e,i){r._nodes.forEach(function(e){if(!e.schema||!e.schema.links)return;var n=[],r=0;deep.query(e.schema.links,"./*?rel=in=("+s.join(",")+")").forEach(function(i){var s=deep.interpret(i.href,e.value);n.push(deep.get(s,{defaultProtocole:"json",wrap:{path:t[i.rel]}})),r++})});if(alls.length==0)return;return deep.all(alls).done(function(e){return e.forEach(function(e){deep.utils.setValueByPath(entry.value,e.path,e.result,n)}),e})};return u._isDone_=!0,i.apply(this,[u]),this}},d=function(e,t){var n=null;return typeof e=="function"?n=e(t):n=deep.utils.applyTreatment.call(e,t),typeof n=="undefined"?t:n};return deep.utils.up(f,deep.Chain.prototype),deep.chain={addInChain:i,stringify:function(t,n){n=n||{};var r="";return t._nodes.forEach(function(e){n.pretty?r+=JSON.stringify(e.value,null," ")+"\n":r+=JSON.stringify(e.value)+"\n"}),r},clear:function(t){return t.oldQueue=[],t.callQueue=[],t},transform:function(t,n){var r={results:[],nodes:null,promise:null};return t._queried?(r.nodes=t._nodes,r.nodes.forEach(function(e){r.results.push(n(e.value))}),r.promise=deep.all(r.results)):(r.nodes=t._nodes[0],r.nodes.value instanceof Array?(r.nodes.value.forEach(function(e){r.results.push(n(e))}),r.promise=deep.all(r.results)):(r.results=n(r.nodes.value),r.promise=deep.when(r.results))),r.promise.done(function(e){return t._queried?r.nodes.forEach(function(t){t.value=e.shift(),t.ancestor&&(t.ancestor.value[t.key]=t.value)}):(r.nodes.value=e,r.nodes.ancestor&&(r.nodes.ancestor.value[e.key]=e.value)),e})},transformNodes:function(t,n){var r=[];return t.forEach(function(e){r.push(n(e))}),deep.all(r).done(function(e){var n=[];return t.forEach(function(t){t.value=e.shift(),t.ancestor&&(t.ancestor.value[t.key]=t.value),n.push(t.value)}),n})},val:function(t){return t._nodes.length===0?undefined:t._queried?this.values(t):t._nodes[0].value},first:function(t,n){if(t._nodes.length===0)return undefined;var r=t._nodes[0];if(!t._queried&&r.value instanceof Array){var i=r.value[0];return n&&(t._queried=!1,t._nodes=deep.query(r,"./0",{resultType:"full"})),i}return n&&(t._nodes=[r]),r.value},last:function(t,n){if(t._nodes.length===0)return undefined;if(t._queried){var r=t._nodes[t._nodes.length-1];return n&&(t._nodes=[r]),r.value}var i=t._nodes[0];if(i.value instanceof Array){var s=i.value.length-1,o=i.value[s];return n&&(t._queried=!1,t._nodes=deep.query(i,"./"+s,{resultType:"full"})),o}return i.value},values:function(t){var n=[];return t._nodes.forEach(function(e){n.push(e.value)}),n},each:function(t,n){var r=[];return!t._queried&&t._nodes[0].value instanceof Array?t._nodes[0].value.forEach(function(e){typeof n=="object"?r.push(deep.utils.execTreatment.call(n,e)):r.push(n(e))}):t._nodes.forEach(function(e){typeof n=="object"?r.push(deep.utils.execTreatment.call(n,e.value)):r.push(n(e.value))}),r},nodes:function(t){var n=[];return t._nodes.forEach(function(e){n.push(e)}),n},paths:function(t){var n=[];return t._nodes.forEach(function(e){n.push(e.paths)}),n},schemas:function(e){var t=[];return e._nodes.forEach(function(e){t.push(e.schema)}),t},position:function(t,n,r){r=r||{},t.positions.push({name:n,entries:t._nodes.concat([]),store:t._store,queried:t._queried,queue:r.restartChain?t.callQueue.concat([]):null})}},deep.treat=function(e,t){return deep.utils.applyTreatment.apply(e,[t||{}])},deep.Chain.addHandle("logState",function(){var e=this,t=function(e,t){t?console.log("deep.Chain state : ERROR : ",t):console.log("deep.Chain state : SUCCESS : ",JSON.stringify(e,null," "))};return i.apply(e,[t]),this}),deep.Chain.addHandle("nodes",function(e){var t=this,n=function(n,r){return e(deep.chain.nodes(t))};return n._isDone_=!0,e?(i.apply(t,[n]),this):deep.chain.nodes(t)}),deep.Chain.addHandle("init",function(){var e=arguments,t=this,n=function(n,r){var i=[];return deep.chain.each(t,function(t){typeof t.init=="function"?i.push(t.init.apply(t,e)):i.push(t)}),deep.all(i)};return n._isDone_=!0,i.apply(t,[n]),this}),e("./deep-stores")(deep),e("./deep-ocm")(deep),deep}),define("deep-ui/view-controller",["require","deep/deep"],function(e){var t=e("deep/deep"),n={renderables:{},parentController:null,externals:null,load:function(e){var n=this;return this._externals?this.externals=t.utils.copy(this._externals):this.externals&&(this._externals=t.utils.copy(this.externals)),t(this).query("./externals").deepLoad(this,!0).done(function(e){return n})},setBehaviour:function(){},beforeRefresh:function(){},refresh:t.compose.after(function(){var e=this,n=Array.prototype.slice.call(arguments);return t(this).position("controller").run("beforeRefresh").query("./renderables/["+n.join(",")+"]").values(function(n){return t.utils.loadTreatments(n,e)}).done(function(n){return t.utils.applyTreatments(n,e,!0)}).up({refresh:function(){var n=this.sended();if(n&&n.parents("html").length>0)return t(this).values(function(n){return t.utils.loadTreatments(n,e)}).done(function(n){return t.utils.applyTreatments(n,e,!0)})}}).back("controller").run(function(){this.deepLinkPath&&smart.app.updateDeepLink(this.deepLinkPath)}).run(function(){var e=t(this.renderables).query("./*/sended").run().done();this.setBehaviour&&n.length==0&&this.setBehaviour(e),this.hasRefresh&&n.length==0&&this.hasRefresh(e)}).done(function(){return e})}),show:function(){var e=this,n=Array.prototype.slice.call(arguments).join(",");return t(this).position("controller").query("./renderables/["+n+"]").run(function(){this.sended&&this.sended()&&this.sended().show()}).done(function(){return e})},hide:function(){var e=this,n=Array.prototype.slice.call(arguments).join(",");return t(this).position("controller").query("./renderables/["+n+"]").run(function(){this.sended&&this.sended()&&this.sended().hide()}).done(function(){return e})},me:function(e){return this}};return n}),define("deep-ui/app-controller",["require","./plugin"],function(t){var n=t("deep/deep"),r={init:function(){},load:function(){return n(this).query("./externals").deepLoad(null,!0)},currentView:null,updateDeepLink:function(e){if(e==$.address.path())return;var t=e.split("/"),n=this.deeplinkingMap;typeof n=="function"&&(n=n());if(!n)return;var r=!0,i=[];while(t.length>0){var s=t.shift();if(s=="")continue;n=n[s];if(!n){console.warn("_App.updateDeepLink failed : no current map entry found with : ",s),r=!1;break}n._output?i.push(n._output.apply(this)):i.push(s)}r&&$.address.path(i.join("/"))},internalChange:function(e,t){var n=e.split("/");n[0]==""&&n.shift();var r={pathNames:n,path:e,parameters:t};this.urlChanged(r)},urlChanged:function(e){var t=this.deeplinkingMap;typeof t=="function"&&(t=t());var n=t,r=!0;while(e.pathNames.length>0&&r){r=!1;var i=e.pathNames.shift(),s=!1;if(!n)return;if(n[i])n=n[i],r=!0;else if(n._int_){var o=parseInt(i);isNaN(o)||(n=n._int_,r=!0)}else n._id_?(n=n._id_,r=!0):console.log("Dont find what i want in the url, redirect to default view")}if(r&&n._handler)e.pathNames=e.path.split("/"),e.pathNames[0]==""&&e.pathNames.shift(),n._handler.apply(this,[e]);else{var u=n.defaultHandler||t.defaultHandler;u?u.apply(this):console.log("deep-link failed : nothing to do with : ",e)}}};return r}),define("deep-ui/inputs-data-binder",["require","deep/deep"],function(e){var t=e("deep/deep"),n=function(){};return n.prototype.datas=null,n.prototype.pathMap=null,n.prototype.output=null,n.prototype.inputs=null,n.prototype.parentSelector=null,n.prototype.init=function(t,n,r){return this.output={},this.inputs=[],this.schema=r||{},this.parentSelector=t,n?(this.datas=n,this.fillFields(n)):this.datas={},this},n.prototype.replaceInDataPaths=function(t,n){return $(this.parentSelector+" input[data-path]").each(function(){var r=$(this).attr("data-path");$(this).attr("data-path",r.replace(t,n))}),$(this.parentSelector+" select[data-path]").each(function(){var r=$(this).attr("data-path");$(this).attr("data-path",r.replace(t,n))}),$(this.parentSelector+" textarea[data-path]").each(function(){var r=$(this).attr("data-path");$(this).attr("data-path",r.replace(t,n))}),this},n.prototype.toDatas=function(){this.output={},this.createPathMap();for(var n in this.pathMap)for(var r=0;r<this.pathMap[n].entries.length;++r){var i=this.pathMap[n].entries[r],s=null;switch(i.type){case"checkbox":$(i.input).prop("checked")&&(s=$(i.input).val());break;case"button":break;case"submit":break;case"radio":$(i.input).prop("checked")&&(s=$(i.input).val());break;case"select":s=new Array,$(i.input).find("option:selected").each(function(){s.push($(this).val())}),!$(i.input).prop("multiple")&&s.length==1&&(s=s.shift());break;case"text":case"hidden":case"password":case"textarea":$(i.input).hasClass("html-text")?s=$(i.input).data("liveEdit").getXHTMLBody():s=$(i.input).val();break;default:null}if(s=="null"||s=="undefined"||s==undefined)s=null;if(this.pathMap[n].schema&&!(s==null&&this.pathMap[n].schema.type&&this.pathMap[n].schema.type instanceof Array&&t.utils.inArray("null",this.pathMap[n].schema.type||[])))switch(this.pathMap[n].schema.type){case"array":i.lastNodeRef[i.lastPathPart]==null&&(i.lastNodeRef[i.lastPathPart]=new Array);break;case"number":s=parseFloat(s);break;case"float":s=parseFloat(s);break;case"integer":s=parseInt(s);break;case"boolean":s=s=="true"||s=="1"?!0:!1;break;default:}i.lastNodeRef[i.lastPathPart]&&i.lastNodeRef[i.lastPathPart].push?s!=null&&(i.lastNodeRef[i.lastPathPart].push(s),this.pathMap[n].entries[r].val=i.lastNodeRef[i.lastPathPart]):s!=null&&(i.type!="radio"||!this.pathMap[n].radioValue)&&(i.lastNodeRef[i.lastPathPart]=s,this.pathMap[n].entries[r].val=i.lastNodeRef[i.lastPathPart],i.type=="radio"&&(this.pathMap[n].radioValue=s))}return this.output},n.prototype.fillFields=function(n){this.createPathMap(),n&&(this.datas=n);for(var r in this.pathMap){var i=t.utils.retrieveValueByPath(this.datas,r),s=0;for(var o=0;o<this.pathMap[r].entries.length;++o){var u=this.pathMap[r].entries[o],a=i;i&&i.push&&i.forEach&&i.length&&(a=i[s],s++);switch(u.type){case"checkbox":if(a==null)break;($(u.input).val()==a||a instanceof Array&&t.utils.inArray($(u.input).val(),a))&&$(u.input).prop("checked",!0);break;case"radio":if(a==null)break;$(u.input).val()==a&&$(u.input).prop("checked",!0);break;case"select":if(a==null)break;$(u.input).find(" option[value='"+a+"']").prop("selected",!0);break;default:if(a==null){$(u.input).val("");break}$(u.input).val(a)}}}return this},n.prototype.createPathMap=function(){var n=this.pathMap=new Object,r=this,i=this.output={};return $(this.parentSelector+" input[data-path]").each(function(){var s=$(this).attr("data-path"),o={};r.schema&&(o=t.utils.retrieveFullSchemaByPath(r.schema,s)),r.inputs.push(this);var u=s.split("."),a=i;while(u.length>1){var f=u.shift();typeof a[f]=="undefined"&&(a[f]={}),a=a[f]}var l=u.shift();a[l]==undefined&&(a[l]=null),n[s]||(n[s]={}),n[s].schema=o,n[s].entries||(n[s].entries=new Array),n[s].entries.push({input:this,schema:o,type:$(this).attr("type"),val:null,lastPathPart:l,lastNodeRef:a})}),$(this.parentSelector+" select[data-path]").each(function(){var s=$(this).attr("data-path"),o=s.split("."),u={};r.schema&&(u=t.utils.retrieveFullSchemaByPath(r.schema,s)),r.inputs.push(this);var a=i;while(o.length>1){var f=o.shift();typeof a[f]=="undefined"&&(a[f]=new Object),a=a[f]}var l=o.shift();a[l]==undefined&&(a[l]=null),n[s]||(n[s]={}),n[s].schema=u,n[s].entries||(n[s].entries=new Array),n[s].entries.push({input:this,val:null,schema:u,type:"select",lastPathPart:l,lastNodeRef:a})}),$(this.parentSelector+" textarea[data-path]").each(function(){var s=$(this).attr("data-path");r.schema&&(schem=t.utils.retrieveFullSchemaByPath(r.schema,s)),r.inputs.push(this);var o=s.split("."),u=i;while(o.length>1){var a=o.shift();typeof u[a]=="undefined"&&(u[a]=new Object),u=u[a]}var f=o.shift();n[s]||(n[s]={}),n[s].schema=schem,n[s].entries||(n[s].entries=new Array),n[s].entries.push({input:this,val:null,type:"textarea",schema:schem,lastPathPart:f,lastNodeRef:u})}),this},n.prototype.clear=function(){return this.output={},$(this.parentSelector+" input").each(function(){var t=$(this).attr("type");(t=="text"||t=="hidden")&&$(this).val(""),(t=="checkbox"||t=="radio")&&$(this).prop("checked",!1)}),$(this.parentSelector+" select").find("option:selected").prop("selected",!1),$(this.parentSelector+" select").find("option:first").prop("selected",!0),$(this.parentSelector+" textarea").val(""),$(this.parentSelector+" input.error").removeClass("error"),$(this.parentSelector+" textarea.error").removeClass("error"),$(this.parentSelector+" select.error").removeClass("error"),this},n.prototype.partialValidation=function(e){console.log("partial validation"),this.toDatas();var n=this,r=t.partialValidation(this.output,this.schema,{fieldsToCheck:e});if(!r.valid)for(var i in r.errorsMap){var s=r.errorsMap[i];n.pathMap[i]?s.itemsMap=n.pathMap[i].entries:s.itemsMap=[]}return r},n.prototype.validate=function(){this.toDatas();var e=this,n=t.validate(this.output,this.schema);if(!n.valid)for(var r in n.errorsMap){var i=n.errorsMap[r];e.pathMap[r.substring(1)]?i.itemsMap=e.pathMap[r.substring(1)].entries:i.itemsMap=[]}return n},n}),define("deep-ui/html-binder",["require","./plugin"],function(e){return function(e){function t(t,n){var r=this;(function(){$(t).html(r.createInputHtml(n)).find(".property-input:first").blur(function(i){var s=n.value;n.value=e.Validator.convertStringTo($(this).val(),n.type),$(t).text(n.value),n.value!==s&&r.hasChange(s,n)}).focus().click(function(e){e.stopPropagation()}).keydown(function(e){if(e.keyCode==27){$(t).text(n.value);return}e.keyCode==13&&$(this).blur()})})()}var n=function(){};return n.prototype={templates:{inputText:"swig::/js/deep-ui/templates/json-editor/input-text.html",node:"swig::/js/deep-ui/templates/json-editor/node.html",item:"swig::/js/deep-ui/templates/json-editor/item.html"},editKeyAcess:!0,editValueInPlace:function(e,n){var r=this;$(e).click(function(e){e.preventDefault(),t.apply(r,[this,n])})},editKeyInPlace:function(n,r){var i=this;$(n).click(function(n){n.preventDefault();var s={path:r.path,key:r.key,value:r.key,type:e.Validator.getType(r.key)};t.apply(i,[this,s])})},createInputHtml:function(e){return this.templates.inputText(e)},createPropertyHtml:function(e){return this.templates.item(e)},createObjectNodeHtml:function(e){return this.templates.node(e)},createArrayNodeHtml:function(e){return this.templates.node(e)},createHiddenPropertyHtml:function(e){return this.templates.item(e)},placeEntries:function(t,n,r){var i=this,s=[];for(var o in t){if(!t.hasOwnProperty(o))continue;s.push({key:o,value:t[o]})}s.forEach(function(t){i.currentPath.push(t.key),t.path=i.currentPath.join("."),t.type=e.Validator.getType(t.value),t.depth=i.currentPath.length;if(t.path!="id")switch(t.type){case"array":var s=$(i.createArrayNodeHtml(t)).appendTo(n);i.editKeyAcess&&(!r||r.type!="array")&&i.editKeyInPlace($(s).find(".property-key:first"),t),i.placeEntries(t.value,$(s).find(".property-childs:first"),t);break;case"object":var s=$(i.createObjectNodeHtml(t)).appendTo(n);i.editKeyAcess&&(!r||r.type!="array")&&i.editKeyInPlace($(s).find(".property-key:first"),t),i.placeEntries(t.value,$(s).find(".property-childs:first"),t);break;default:var s=$(i.createPropertyHtml(t)).appendTo(n);i.editValueInPlace($(s).find(".property-value:first"),t),i.editKeyAcess&&(!r||r.type!="array")&&i.editKeyInPlace($(s).find(".property-key:first"),t)}else var s=$(i.createHiddenPropertyHtml(t)).appendTo(n).css("display","none");i.currentPath.pop()})},delegateHasChange:function(e,t,n){console.log("DEFAULT DELEGATE NOT BINDED : json-editor.delegateHasChange : ",t," - ",n)},hasChange:function(e,t){this.delegateHasChange(this,e,t)}},e.ui.toEditableHTML=function(t,r,i,s,o){var u=[],a=new n;return u.push(e(s||a.templates).query(".//*?_schema.type=string").load()),u.push(e.when(e.get(t))),i&&u.push(e.when(e.get(i))),e(e.all(u).done(function(e){return e.shift(),a.currentPath=[],a.json=e.shift(),i&&(a.schema=e.shift()),s&&(a.templates=s),a.editKeyAccess=o,$(r).empty(),a.placeEntries(a.json,r,null),a}))},e.ui.fromEditableHTML=function(t,n){var r={},i=[r];return $(t).find(" *[property-type]").each(function(){var t=$(this).attr("property-type"),n=parseInt($(this).attr("property-depth")),r=$(this).find(".property-key:first").text();while(i.length>n)i.pop();var s=i[i.length-1],o=null;switch(t){case"array":o=[];break;case"object":o={};break;default:o=$(this).find(".property-value:first").text(),o=e.Validator.convertStringTo(o,t)}s instanceof Array?s.push(o):s[r]=o,(t=="array"||t=="object")&&i.push(o)}),e(r)},n}}),define("deep-ui/plugin",["require","deep/deep","./view-controller","./app-controller","./inputs-data-binder","./html-binder"],function(e,t,n,r,i){var s={deeplink:function(e,n){var r=e,i=null;typeof e=="object"&&(i=r.parameters,e=r.path);var s=this,o=function(t,s){return console.log("deeplink plugin : path=",r),n?smart.app.internalChange(e,i):smart.app.updateDeepLink(e,i),!0};return t.chain.addInChain.apply(this,[o]),this}};return t.utils.up(s,t.Chain.prototype),t.ui={appendTo:function(e,t){return function(n,r){if(!t&&r&&r.parents("html").length>0){var i=$(n);return $(r).replaceWith(i),i}return r=$(n).appendTo(e),r}},prependTo:function(e,t){return function(n,r){if(!t&&r&&r.parents("html").length>0){var i=$(n);return $(r).replaceWith(i),i}return $(n).prependTo(e)}},replace:function(e){return function(t,n){var r=$(t);return $(e).replaceWith(r),r}},htmlOf:function(e){return function(t,n){return $(e).empty(),$(t).appendTo(e)}},ViewController:n,AppController:r,Binder:i,render:function(e,n){return t(t.getAll([e,n])).done(function(t){return e=t.shift(),n=t.shift(),e(n)})}},t.linker={addToPath:function(e){e instanceof DeepHandler&&(e=e._nodes[0].value),console.log(" DEEP.LINKER Add TO PATH : ",e);var t=$.address.path();t[t.length-1]!="/"&&(t+="/"),$.address.path(t+e)},setPath:function(e){$.address.path(e)}},t.ui.toDataPath=function(e,n,r){var s=new i;return s.init(n,e,r),t(s)},t.ui.fromDataPath=function(e,n){var r=new i;return r.init(e,null,n),t(r.toDatas())},t.protocoles.dom={},t.protocoles.dom.appendTo=function(e,n){return t.ui.appendTo(e)},t.protocoles.dom.prependTo=function(e,n){return t.ui.prependTo(e)},t.protocoles.dom.htmlOf=function(e,n){return t.ui.htmlOf(e)},t.protocoles.dom.replace=function(e,n){return t.ui.replace(e)},t.Chain.addHandle("refresh",function(){var e=arguments,n=this,r=function(r,i){var s=[];return t.chain.each(n,function(t){typeof t.refresh=="function"?s.push(t.refresh.apply(t,e)):s.push(t)}),t.all(s).done(function(e){return n._queried?e:e.shift()})};return r._isDone_=!0,t.chain.addInChain.apply(n,[r]),this}),e("./html-binder")(t),t}),define("deep-swig/init",["require","deep/deep"],function(e,t){function i(e){var n={filters:r,allowErrors:!0,autoescape:!0,encoding:"utf8",root:"/",tags:{},extensions:{},tzOffset:0};e&&t.utils.up(e,n);for(var i in n.filters)swig.setFilter(i,n.filters[i])}var n=t.utils,r={randomItem:function(e){return e.push?e[Math.round(Math.random()*(e.length-1))]:e},mongoIDtoStringID:function(e){return e},inArray:function(e,t){return n.inArray(e,t)},outArray:function(e,t){return!n.inArray(e,t)},select:function(e,t){return console.log("swig.filter.select : ",e,t),n.retrieveValueByPath(e,t)},notnull:function(e){return e==null||e=="null"?"":e},comaArray:function(e){var t="",n=!0;for(var r=0;r<e.length;++r)n?n=!1:t+=", ",t+=String(e[r]);return t},writeTaxo:function(e,t){var n="",r=!0;for(var i=0;i<e.length;++i){if(!t["m"+e[i]])continue;r?r=!1:n+=", ",n+=String(t["m"+e[i]].label.fr)}return n},idToLabel:function(e,t,n){for(var r=0;r<t.length;r++){var i=t[r];if(i.id==e)return i.label[n]}},selectIfinArray:function(e,t){return n.inArray(e,t)?"selected":""},checkIfinArray:function(e,t){return n.inArray(e,t)?"checked":""},smartdate:function(e){var t=parseInt(e),n=new Date(t*1e3);return n.toLocaleDateString()+" - "+n.toLocaleTimeString()},query:function(e,t){return e.path?JsonQuery.query(e,(e.path!="/"?e.path+"/":e.path)+t,null,null,{keepCache:!0}):JsonQuery.query(e,t,null,null,{keepCache:!0})},removeFirstChar:function(e){return e.substring(1)},json:function(e){return JSON.stringify(e,null," ")},floor:function(e){return Math.floor(e)},ceil:function(e){return Math.ceil(e)},gridCollumnIndex:function(e,t){return e%t},isTypeOfObject:function(e){return console.log("typeofobject : ",e),typeof e=="object"?!0:!1}};return r.join_coma=r.comaArray,t.utils.getMacroImport=function(e,t){var n="";if(e.layer&&e.layer.templates){var r=e.layer.templates.macros;for(var i in r){if(!r.hasOwnProperty(i)||t&&!i in t)continue;var s=r[i],o="",u=s.indexOf(":");u>-1&&(o=s.substring(0,u),s=s.substring(u+2)),n+="{% import '"+s+"' as "+i+" %}\n"}}return n},i}),define("deep-swig/index",["require","deep/deep","./init"],function(e,t){t.isNode&&(swig=e("swig")),t.ui=t.ui||{},t.ui.swig=function(e,t){return t=t||{},swig.compile(e,t)},t.protocoles.swig=new t.Store,t.extensions.push({store:t.protocoles.swig,extensions:[/(\.(swig)(\?.*)?)$/gi]});if(t.isNode){var n=e("fs");t.protocoles.swig.watched={},t.protocoles.swig.responseParser=function(e,t){e instanceof Buffer&&(e=e.toString("utf8"));var n=swig.compile(e);return n},t.protocoles.swig.get=function(e,r){r=r||{};var i="swig::"+e;if(r.cache!==!1&&t.mediaCache.cache[i])return t.mediaCache.cache[i];var s=t.Deferred(),o=this;this.watched[e]||(this.watched[e]=n.watch(e,function(r,s){switch(r){case"change":n.readFile(e,function(n,r){var s=null;n?s=t.when(t.errors.Watch("Error while reloading file : "+e)):s=t.when(o.responseParser(r,e)),t.mediaCache.manage(s,i)});break;case"rename":t.mediaCache.remove(i)}})),n.readFile(e,function(t,n){if(t)return s.reject(t);s.resolve(o.responseParser(n,e))});var u=s.promise();return r.cache!==!1&&t.mediaCache.manage(u,i),u}}else{var r=function(e,n){for(var r in t.globalHeaders)e.setRequestHeader(r,t.globalHeaders[r]);for(r in this.headers)e.setRequestHeader(r,this.headers[r]);for(r in n)e.setRequestHeader(r,n[r])};t.protocoles.swig.get=function(e,n){n=n||{};var i="swig::"+e;if(n.cache!==!1&&t.mediaCache.cache[i])return t.mediaCache.cache[i];var s=this,o=t.Deferred(),u=$.ajax({beforeSend:function(e){r(e,{Accept:"text/html; charset=utf-8"})},url:e,method:"GET"}).done(function(e,t,n){o.resolve(e)}).fail(function(){o.reject(t.errors.Protocole("deep.protocoles.swig failed : "+e+" - \n\n"+JSON.stringify(arguments)))}),a=o.promise().done(function(n){var r=swig.compile(n,{filename:t.utils.stripFirstSlash(e)});return r});return n.cache!==!1&&t.mediaCache.manage(a,i),a}}return e("./init")}),define("deep-selector/index",["require","deep/deep"],function(e,t){return t.Chain.addHandle("selector",function(n,r){var i=this,s=function(s,o){var u=t.selector(t.chain.val(i),n,r);return u};return s._isDone_=!0,t.chain.addInChain.call(i,s),this}),t.store.Selector=t.compose.Classes(t.Store,function(e,t,n,r){t&&(this.root=t),n&&(this.selector=n)},{get:function(n,r){r=r||{};var i=r.entry||this.root;if(!i)return t.when(t.errors.Store("no object to apply selector on for query : "+n));i._isDQ_NODE_&&(i=entry.value),i._deep_ocm_&&(i=i());var s=t.selector(i,n,this.selector);return t.when(s)}}),t.selector=function(n,r,i){var s=t.store.Selector.parse(r),o=s.shift(),u=[],a=[],f=n;f.push&&(a=f,f=a.shift());while(o){var l=null;o=="this.*"||o===""?l=new Function("return true;"):l=new Function("return "+o+";");while(f){var c=t.Querier.objectsWithProperty(f,i,!0),h=c.shift();while(h){var p={},d=h[i],v=d.length;for(var m=0;m<v;++m)p[d[m]]=!0;p.___func___=l,p.___func___()&&u.push(h),h=c.shift()}f=a.shift()}if(u.length===0)break;o=s.shift(),o&&(a=u,f=a.shift(),u=[])}return u},t.store.Selector.parse=function(t){var n=t[0],r=[],i="",s=0;while(n)switch(n){case"|":case"&":case"(":case")":case" ":case"!":i+=n,n=t[++s];break;case">":r.push(i),n=t[++s],i="";break;default:i+="this.";var o=s;while(n){var u=!1;switch(n){case"|":case"&":case"(":case")":case" ":case">":case"!":u=!0}if(u){i+=t.substring(s,o),s=o;break}n=t[++o],n||(i+=t.substring(s,o))}}return i.length>0&&r.push(i),r},t.store.Selector.create=function(n,r,i){var s=new t.store.Selector(n,r,i);n&&t.utils.up(t.protocole.SheetProtocoles,s)},t.store.Selector}),define("deep-jquery-ajax/lib/ajax",["require","deep/deep"],function(e,t){return t.store.jqueryajax=t.store.jqueryajax||{},t.store.jqueryajax.AJAX=t.compose.Classes(t.Store,function(e,n,r,i){i=i||{},this.baseURI=n||"",this.schema=r,i.dataType&&(this.dataType=i.dataType),i.headers&&t.utils.up(i.headers,this.headers)}),t.store.jqueryajax.AJAX.prototype={headers:{Accept:"application/json; charset=utf-8","Content-Type":"application/json; charset=utf-8"},dataType:"json"},t.store.jqueryajax.AJAX.prototype.writeHeaders=function(e,n){for(var r in t.globalHeaders)e.setRequestHeader(r,t.globalHeaders[r]);for(r in this.headers)e.setRequestHeader(r,this.headers[r]);for(r in n)e.setRequestHeader(r,n[r])},t.store.jqueryajax.AJAX.prototype.bodyParser=function(e){try{typeof e!="string"&&(e=JSON.stringify(e))}catch(t){return t}return e},t.store.jqueryajax.AJAX.prototype.responseParser=function(e,t,n){try{typeof e=="string"&&(e=JSON.parse(e))}catch(r){return r}return e},t.store.jqueryajax.AJAX.prototype.get=function(e,n){var r=!0;if(e!==""&&this.extensions)for(var i=0;i<this.extensions.length;++i){var s=e.match(this.extensions[i]);if(s&&s.length>0){r=!1;break}}this.baseURI&&(e=this.baseURI+(e?e:""));var o=this.dataType+"::"+e;if(!r&&e!==""&&t.mediaCache.cache[o])return t.mediaCache.cache[o];var u=this,a=t.when($.ajax({beforeSend:function(e){u.writeHeaders(e,n.headers)},url:e,method:"GET"}).done(function(e,t,n){return e=u.responseParser(e,t,n),e instanceof Error?e:e}).fail(function(){return new Error("deep.protocoles."+u.protocole+" failed : "+e+" - \n\n"+JSON.stringify(arguments))}));return!r&&n&&n.cache!==!1&&t.mediaCache.manage(a,o),a},t.store.jqueryajax.AJAX.prototype.put=function(e,n){n=n||{};var r=e.id||n.id;n.uri?r=n.uri+(r?r:""):this.baseURI&&(r=this.baseURI+(r?r:""));var i=this,s=t.Deferred(),o=i.bodyParser(e);return o instanceof Error?t(o):($.ajax({beforeSend:function(e){i.writeHeaders(e,n.headers)},type:"PUT",url:r,dataType:i.dataType,data:o}).done(function(e,t,n){e=i.responseParser(e,t,n),s.resolve(e)}).fail(function(e,t,n){if(e.status<400){var o=i.responseParser(e.responseText,t,e);s.resolve(o)}else s.reject(new Error("deep.store."+i.name+".put failed : "+r+" - details : "+JSON.stringify(arguments)))}),s.promise())},t.store.jqueryajax.AJAX.prototype.post=function(e,n){n=n||{};var r=e.id||n.id;n.uri?r=n.uri+(r?r:""):this.baseURI&&(r=this.baseURI+(r?r:""));var i=this,s=t.Deferred(),o=i.bodyParser(e);return o instanceof Error?t.when(o):($.ajax({beforeSend:function(e){i.writeHeaders(e,n.headers)},type:"POST",url:r,dataType:i.dataType,data:o}).done(function(e,t,n){e=i.responseParser(e,t,n),s.resolve(e)}).fail(function(e,t,n){if(e.status<400&&t!=="error"){var o=i.responseParser(e.responseText,t,e);s.resolve(o)}else s.reject(new Error("deep.store."+i.name+".post failed : "+r+" - details : "+JSON.stringify(arguments)))}),s.promise())},t.store.jqueryajax.AJAX.prototype.del=function(e,n){var r=this,i=t.Deferred();return this.baseURI&&(e=this.baseURI+(e?e:"")),$.ajax({beforeSend:function(e){r.writeHeaders(e,n.headers)},type:"DELETE",url:e}).done(function(e,t,n){e=r.responseParser(e,t,n),i.resolve(e)}).fail(function(n,s,o){if(n.status<400){var u=r.responseParser(n.responseText,s,n);i.resolve(u)}else i.reject(t.errors.Store("deep.store."+r.name+".del failed : "+e+" - details : "+JSON.stringify(arguments)))}),i.promise()},t.store.jqueryajax.AJAX.prototype.patch=function(e,n){n=n||{};var r=e.id||n.id;n.uri?r=n.uri+(r?r:""):this.baseURI&&(r=this.baseURI+(r?r:""));var i=this,s=t.Deferred(),o=i.bodyParser(e);return o instanceof Error?t.when(o):($.ajax({beforeSend:function(e){i.writeHeaders(e,n.headers)},type:"PATCH",url:r,dataType:i.dataType,data:o}).done(function(e,t,n){e=i.responseParser(e,t,n),s.resolve(e)}).fail(function(e,t,n){if(e.status<400){var o=i.responseParser(e.responseText,t,e);s.resolve(o)}else s.reject(new Error("deep.store."+i.name+".patch failed : "+r+" - details : "+JSON.stringify(arguments)))}),s.promise())},t.store.jqueryajax.AJAX.prototype.bulk=function(e,n,r){var i=this;r=r||{};var s=t.Deferred();return $.ajax({beforeSend:function(e){i.writeHeaders(e,r.headers)},type:"POST",url:n,dataType:i.dataType,data:JSON.stringify(e)}).done(function(e,t,n){e=i.responseParser(e,t,n),s.resolve(e)}).fail(function(e,t,r){if(e.status<400){var o=i.responseParser(e.responseText,t,e);s.resolve(o)}else s.reject(new Error("deep.store."+i.name+".bulk failed : "+n+" - details : "+JSON.stringify(arguments)))}),s.promise()},t.store.jqueryajax.AJAX.prototype.rpc=function(e,n,r,i){var s=this;i=i||{};var o="call"+(new Date).valueOf();this.baseURI&&(r=this.baseURI+(r?r:""));var u=t.Deferred();return $.ajax({beforeSend:function(e){s.writeHeaders(e,i.headers)},type:"POST",url:r,data:JSON.stringify({id:o,method:e,params:n||[]})}).done(function(e,t,n){e=s.responseParser(e,t,n),e.error?u.reject(e.error):u.resolve(e.result)}).fail(function(e,t,n){if(e.status<400){var i=s.responseParser(e.responseText,t,e);i&&i.error?u.reject(i.error):u.resolve(i.result)}else u.reject(new Error("deep.store."+s.name+".rpc failed : "+r+" - details : "+JSON.stringify(arguments)))}),u.promise()},t.store.jqueryajax.AJAX.prototype.range=function(e,n,r,i){function l(e,n){var r=[],i={},o=e.getResponseHeader("content-range");o=o.substring(6),o&&(r=o.split("/"));if(o&&r&&r.length>0){i.range=r[0];if(i.range=="0--1")i.totalCount=0,i.start=0,i.end=0;else{i.totalCount=parseInt(r[1],10);var u=r[0].split("-");i.start=parseInt(u[0],10),i.end=parseInt(u[1],10)}}else console.log("ERROR deep.protocoles."+s.name+".range : range header missing !! ");return i=t.utils.createRangeObject(i.start,i.end,i.totalCount),i.results=n,i}var s=this,o=e,u=n,a=t.Deferred();this.baseURI&&(r=this.baseURI+(r?r:"")),typeof o=="object"&&(o=o.step*o.width,u=(o.step+1)*o.width-1);var f={range:"items="+o+"-"+u};return i.headers&&t.utils.up(i.headers,f),$.ajax({beforeSend:function(e){s.writeHeaders(e,f)},type:"GET",url:r,dataType:s.dataType}).then(function(e,t,n){return a.resolve(l(n,e))},function(e,t,n){if(e.status==200||e.status==206){var r=s.responseParser(e.responseText,t,e);a.resolve(l(e,r))}else a.reject(new Error("deep.store."+s.name+".range failed : details : "+JSON.stringify(arguments)))}),a.promise()},t.store.jqueryajax.AJAX}),define("deep-jquery-ajax/lib/json",["require","deep/deep","./ajax"],function(e,t,n){return t.store.jqueryajax=t.store.jqueryajax||{},t.store.jqueryajax.JSON=t.compose.Classes(n),t.extensions.push({extensions:[/(\.json(\?.*)?)$/gi],store:t.store.jqueryajax.JSON}),t.store.jqueryajax.JSON.createDefault=function(){new t.store.jqueryajax.JSON("json")},t.store.jqueryajax.JSON}),define("deep-local-storage/index",["require","deep/deep"],function(e,t){return t.store.jstorage=t.store.jstorage||{},t.store.jstorage.Object=t.compose.Classes(t.store.Object,function(e,n,r,i){i=i||{};var s=i.path||e;if(!s)throw t.errors.Store("jstorage.Object need a path at constructor. please provide a options.path or a protocole.");var o=n||this.root||$.jStorage.get(s);o||(o={},$.jStorage.set(s,o,i)),this.root=o,t.utils.sheet({"dq.up::./[post,put,patch,del]":t.compose.around(function(e){return function(n,r){var o=t.utils.bottom(i,r),u=this;return t.when(e.call(this,n,o)).done(function(e){$.jStorage.set(s,u.root,o)})}})},this)},{flush:function(e){this.root={},$.jStorage.set(path,this.root,e)}}),t.store.jstorage.Object.create=function(e,n,r,i){return new t.store.jstorage.Object(e,n,r,i)},t.store.jstorage.Collection=t.compose.Classes(t.store.Collection,function(e,n,r,i){i=i||{};var s=i.path||e;if(!s)throw t.errors.Store("jstorage.Collection need a path at constructor. please provide a options.path or a protocole.");var o=n||this.collection||$.jStorage.get(s);o||(o=[],$.jStorage.set(s,o,i)),this.collection=o,t.utils.sheet({"dq.up::./[post,put,patch,del]":t.compose.around(function(e){return function(n,r){var o=t.utils.bottom(i,r),u=this;return t.when(e.call(this,n,o)).done(function(e){$.jStorage.set(s,u.collection,o)})}})},this)},{flush:function(e){this.collection=[],$.jStorage.set(path,this.collection,e)}}),t.store.jstorage.Collection.create=function(e,n,r,i){return new t.store.jstorage.Collection(e,n,r,i)},t.store.JStorage}),define("/js/./view-aspect.js",["require","deep/deep"],function(e,t){var n={load:t.compose.after(function(){var e=Array.prototype.slice.call(arguments);return t.all(t(this.externals).deepLoad(this),t(this).query("./renderables/["+e.join(",")+"]").values(function(e){return t.utils.loadTreatments(e,self)}))}),refresh:t.compose.after(function(){var e=this,n=e.externals;return this.load.apply(this,arguments).done(function(n){return e.externals=n.shift(),t.utils.applyTreatments(n.shift(),e,!0)}).done(function(){e.externals=n})})};return n}),define("/js/home-controller.js",["require","deep/deep","./view-aspect.js"],function(e,t){var n={backgrounds:["js::/js/view-aspect.js"],deepLinkPath:"/home",externals:{},renderables:{self:{how:"swig::./templates/home.html",where:"dom.htmlOf::#content",done:function(e){console.log("Home rendered()")}}}};return n}),define("app-controller.js",["require","deep/deep","deep-ui/plugin","deep-swig/index","deep-selector/index","deep-jquery-ajax/lib/json","deep-local-storage/index","/js/home-controller.js"],function(e){deep.store.jqueryajax.JSON.createDefault(),deep.store.jstorage.Collection.create("myobjects",null,null,{methods:{first:function(e,t,n){return console.log("my objects rpc : call on : ",this," - arg 1  :",t," - arg2 : ",n),this.test="rpc powaaaaa",e.save()}}}),deep.generalMode("public"),timeline={flatten:function(){return deep.all(this.views.flatten(),this.gui.flatten(),this.routes.flatten())},views:deep.ocm("views.dq"),gui:deep.ocm("gui"),routes:deep.ocm("routes")},deep.store.Selector.create("views",timeline.views,"view-selector"),timeline.views.up({"public":{home:{backgrounds:["js::/js/home-controller.js"],"view-selector":["home"],externals:{test:"json::/json/test.json"}}},user:{},admin:{}}),timeline.gui.up({"public":{home:function(){return deep("views::home").refresh()}},user:{},admin:{}});var t=timeline.flatten();return function(){t.done(function(){timeline.gui().home()})}}),require.config({baseUrl:"./libs",catchError:!0}),require(["./app-controller.js"],function(e){e()}),define("main",function(){})})();